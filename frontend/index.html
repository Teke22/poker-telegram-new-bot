<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Poker</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
button {
  padding:10px;
  margin:5px;
  background:#1a6b52;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
button:hover {
  background:#248464;
}
button:disabled {
  background:#555;
}
input {
  padding:8px;
  margin:5px;
}
.card {
  background:#fff;
  color:#000;
  padding:10px;
  margin:6px;
  border-radius:8px;
  display:inline-block;
  font-weight:bold;
}
.box {
  border:2px solid #1a6b52;
  padding:15px;
  margin-top:15px;
  border-radius:10px;
}
</style>
</head>

<body>

<div id="status"></div>
<div id="app"></div>

<script>
const socket = io({ transports:['websocket'] });

const me = window.Telegram?.WebApp?.initDataUnsafe?.user
  || { id:'debug_'+Math.random(), first_name:'Debug' };

let room = null;
let myCards = [];
let lastState = null;

/* ---------- UI ---------- */

function showLobby() {
  document.getElementById('app').innerHTML = `
    <h2>üé¥ Poker</h2>
    <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button><br><br>
    <input id="code" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
    <button onclick="joinRoom()">–í–æ–π—Ç–∏</button>
  `;
}

function renderGame(state) {
  lastState = state;
  const meState = state.players.find(p => p.id === me.id);

  document.getElementById('app').innerHTML = `
    <h3>–°—Ç–∞–¥–∏—è: ${state.stage}</h3>
    <p>–ë–∞–Ω–∫: ${state.pot}</p>

    <div>
      ${state.players.map(p => `
        <div>${p.name} ‚Äî ${p.chips} ${p.id===state.currentPlayerId?'üëâ':''}</div>
      `).join('')}
    </div>

    <h4>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h4>
    ${myCards.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('')}

    <br><br>
    ${state.currentPlayerId === me.id ? renderActions(meState,state) : '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ...'}
  `;
}

function renderActions(meState,state) {
  const toCall = state.currentBet - meState.bet;

  return `
    <button onclick="check()">‚úì –ß–µ–∫</button>
    <button onclick="fold()">‚ùå –§–æ–ª–¥</button>
    ${toCall>0 ? `<button onclick="call()">üìû –ö–æ–ª–ª</button>` : ''}
    <button onclick="raise()">üìà –†–µ–π–∑</button>
  `;
}

/* ---------- ACTIONS ---------- */

function createRoom() {
  socket.emit('create_room',{ user:me });
}

function joinRoom() {
  const code = document.getElementById('code').value.trim();
  socket.emit('join_room',{ code, user:me });
}

function check() {
  socket.emit('player_action',{
    code: room.code,
    playerId: me.id,
    action: { type:'check' }
  });
}

function fold() {
  socket.emit('player_action',{
    code: room.code,
    playerId: me.id,
    action: { type:'fold' }
  });
}

function call() {
  socket.emit('player_action',{
    code: room.code,
    playerId: me.id,
    action: { type:'call' }
  });
}

function raise() {
  socket.emit('player_action',{
    code: room.code,
    playerId: me.id,
    action: { type:'raise', amount: lastState.currentBet*2 }
  });
}

/* ---------- SOCKET ---------- */

socket.on('room_joined', r => {
  room = r;
});

socket.on('game_started', ({ publicState }) => {
  socket.emit('get_my_cards',{ code:room.code, playerId:me.id });
  renderGame(publicState);
});

socket.on('game_update', renderGame);

socket.on('my_cards', cards => {
  myCards = cards;
});

socket.on('error_msg', msg => alert(msg));

showLobby();
</script>

</body>
</html>
