<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Poker</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
button {
  padding:10px;
  margin:5px;
}
.card {
  background:#fff;
  color:#000;
  padding:8px;
  margin:4px;
  border-radius:6px;
  display:inline-block;
}
</style>
</head>

<body>
<div id="app"></div>

<script>
const tg = Telegram.WebApp;
tg.expand();

const me = tg.initDataUnsafe.user;
const socket = io();

let room = null;
let myCards = [];

/* ---------- render ---------- */

function render(state) {
  const current = state.players.find(p => p.id === state.currentPlayerId);

  document.getElementById('app').innerHTML = `
    <h2>Комната ${room.code}</h2>

    <p>Ход: <b>${current.name}</b></p>

    <ul>
      ${state.players.map(p =>
        `<li>${p.name} ${p.folded ? '(fold)' : ''}</li>`
      ).join('')}
    </ul>

    <h3>Ваши карты</h3>
    ${myCards.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('')}

    <br><br>

    ${state.currentPlayerId === me.id ? `
      <button onclick="act('check')">Check</button>
      <button onclick="act('fold')">Fold</button>
    ` : '<p>Ожидание хода...</p>'}
  `;
}

/* ---------- actions ---------- */

function act(action) {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action
  });
}

/* ---------- socket ---------- */

socket.on('room_joined', r => room = r);
socket.on('room_update', r => room = r);

socket.on('game_started', ({ publicState }) => {
  socket.emit('get_my_cards', { code: room.code, playerId: me.id });
  render(publicState);
});

socket.on('my_cards', cards => myCards = cards);
socket.on('game_update', render);
socket.on('error_msg', alert);
</script>
</body>
</html>
