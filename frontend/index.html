<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Poker</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
button {
  padding:10px;
  margin:5px;
  background:#3498db;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
button:hover {
  background:#2980b9;
}
button:disabled {
  background:#7f8c8d;
  cursor:not-allowed;
}
button.fold {
  background:#e74c3c;
}
button.fold:hover {
  background:#c0392b;
}
button.call {
  background:#2ecc71;
}
button.call:hover {
  background:#27ae60;
}
button.raise {
  background:#f39c12;
}
button.raise:hover {
  background:#d35400;
}
.card {
  background:#fff;
  color:#000;
  padding:6px;
  margin:4px;
  border-radius:6px;
  display:inline-block;
  font-weight:bold;
}
.winner {
  background:#1e7f5c;
  padding:10px;
  margin-top:15px;
  border-radius:8px;
}
.player-item {
  margin:8px 0;
  padding:8px;
  background:rgba(255,255,255,0.1);
  border-radius:5px;
}
.current-turn {
  border-left:4px solid #2ecc71;
  background:rgba(46,204,113,0.2);
}
.folded {
  opacity:0.6;
}
</style>
</head>

<body>

<h1>üÉè Poker Mini App</h1>
<div id="app"></div>

<script>
const socket = io({ transports: ['websocket'] });

const me = {
  id: 'u_' + Math.random().toString(36).slice(2),
  first_name: 'Player',
  chips: 1000
};

let room = null;
let myCards = [];
let lastState = null;
let myPrivateState = null;

/* ---------- UI ---------- */

function renderLobby() {
  document.getElementById('app').innerHTML = `
    <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    <br><br>
    <input id="code" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" />
    <button onclick="joinRoom()">–í–æ–π—Ç–∏</button>
  `;
}

function renderRoom() {
  document.getElementById('app').innerHTML = `
    <h2>–ö–æ–º–Ω–∞—Ç–∞ ${room.code}</h2>
    <ul>
      ${room.players.map(p => `<li>${p.name} (${p.chips})</li>`).join('')}
    </ul>
    <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    <button onclick="leaveRoom()">–í—ã–π—Ç–∏</button>
  `;
}

function renderGame(state) {
  lastState = state;
  
  const isMyTurn = state.currentPlayerId === me.id && !state.finished;
  
  document.getElementById('app').innerHTML = `
    <h2>–ò–≥—Ä–∞</h2>
    <p>–°—Ç–∞–¥–∏—è: ${state.stage} | –ë–∞–Ω–∫: ${state.pot} | –¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: ${state.currentBet}</p>

    <h3>–ö–∞—Ä—Ç—ã —Å—Ç–æ–ª–∞</h3>
    ${state.communityCards.map(c =>
      `<span class="card">${c.rank}${c.suit}</span>`
    ).join('') || '<p>–ù–µ—Ç –∫–∞—Ä—Ç –Ω–∞ —Å—Ç–æ–ª–µ</p>'}

    <h3>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
    ${myCards.map(c =>
      `<span class="card">${c.rank}${c.suit}</span>`
    ).join('') || '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>'}

    <h3>–ò–≥—Ä–æ–∫–∏</h3>
    <ul>
      ${state.players.map(p => `
        <li class="player-item ${p.id === state.currentPlayerId ? 'current-turn' : ''} ${p.folded ? 'folded' : ''}">
          ${p.name} (${p.chips})
          ${p.bet > 0 ? `+${p.bet}` : ''}
          ${p.id === state.currentPlayerId ? ' ‚¨Ö —Ö–æ–¥' : ''}
          ${p.folded ? ' (FOLDED)' : ''}
          ${p.allIn ? ' (ALL-IN)' : ''}
          ${state.finished || p.folded
            ? `<br>${p.showHand.map(c =>
                `<span class="card">${c.rank}${c.suit}</span>`
              ).join('')}`
            : ''}
        </li>
      `).join('')}
    </ul>

    <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
    ${isMyTurn ? renderActionButtons(state) : '<p>–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞...</p>'}

    ${renderWinners(state)}
    
    <!-- –î–∏–∞–ª–æ–≥ –¥–ª—è —Å—Ç–∞–≤–∫–∏/—Ä–µ–π–∑–∞ -->
    <div id="betDialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#2c3e50; padding:20px; border-radius:10px; z-index:1000;">
      <h3>–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</h3>
      <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: <span id="minBetAmount">20</span></p>
      <p>–í–∞—à–∏ —Ñ–∏—à–∫–∏: <span id="maxBetAmount">${me.chips}</span></p>
      <input type="number" id="betInput" min="20" max="${me.chips}" value="20" style="padding:8px; width:100px;">
      <br><br>
      <button onclick="placeBetOrRaise()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      <button onclick="hideBetDialog()" style="background:#7f8c8d">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>
  `;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –¥–∏–∞–ª–æ–≥–µ
  if (state.currentBet === 0) {
    document.getElementById('minBetAmount').textContent = '20';
  } else {
    document.getElementById('minBetAmount').textContent = state.currentBet + (state.minRaise || 20);
  }
}

function renderActionButtons(state) {
  // –ï—Å–ª–∏ —É –Ω–∞—Å –Ω–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
  if (!myPrivateState) {
    return `
      <div>
        <button onclick="fold()" class="fold">–§–æ–ª–¥</button>
        <button onclick="check()">–ß–µ–∫</button>
        <button onclick="call()">–ö–æ–ª–ª</button>
        <button onclick="showBetDialog('bet')">–ë–µ—Ç</button>
        <button onclick="showBetDialog('raise')">–†–µ–π–∑</button>
        <button onclick="allIn()" style="background:#e67e22">All-in</button>
      </div>
    `;
  }
  
  const toCall = state.currentBet - (state.players.find(p => p.id === me.id)?.bet || 0);
  const canCheck = toCall === 0;
  const canCall = toCall > 0 && me.chips >= toCall;
  const canBet = state.currentBet === 0 && me.chips > 0;
  const canRaise = me.chips > toCall;
  
  return `
    <div>
      <h4>–í–∞—à —Ö–æ–¥</h4>
      ${toCall > 0 ? `<p>–ù—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å: ${toCall} —á—Ç–æ–±—ã –∫–æ–ª–ª–∏—Ä–æ–≤–∞—Ç—å</p>` : '<p>–í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —á–µ–∫</p>'}
      
      <button onclick="fold()" class="fold">–§–æ–ª–¥</button>
      
      ${canCheck ? `<button onclick="check()">–ß–µ–∫</button>` : ''}
      
      ${canCall ? `<button onclick="call()" class="call">–ö–æ–ª–ª (${toCall})</button>` : ''}
      
      ${canBet ? `<button onclick="showBetDialog('bet')" class="raise">–ë–µ—Ç</button>` : ''}
      
      ${canRaise ? `<button onclick="showBetDialog('raise')" class="raise">–†–µ–π–∑</button>` : ''}
      
      <button onclick="allIn()" style="background:#e67e22">All-in (${me.chips})</button>
    </div>
  `;
}

function renderWinners(state) {
  if (!state.finished || !state.winners?.length) return '';

  return `
    <div class="winner">
      <h3>üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å${state.winners.length > 1 ? '–∏' : ''}</h3>
      <p><strong>–ö–æ–º–±–∏–Ω–∞—Ü–∏—è:</strong> ${state.winningHandName}</p>
      <ul>
        ${state.winners.map(w => `
          <li><strong>${w.name}</strong></li>
        `).join('')}
      </ul>
    </div>
  `;
}

/* ---------- ACTIONS ---------- */

function createRoom() {
  socket.emit('create_room', { user: me });
}

function joinRoom() {
  const code = document.getElementById('code').value.trim();
  socket.emit('join_room', { code, user: me });
}

function leaveRoom() {
  socket.emit('leave_room', { code: room.code, playerId: me.id });
  room = null;
  renderLobby();
}

function startGame() {
  socket.emit('start_game', { code: room.code });
}

function check() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'check'
  });
}

function call() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'call' }
  });
}

function fold() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'fold'
  });
}

function allIn() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'allin' }
  });
}

let currentActionType = 'bet'; // 'bet' –∏–ª–∏ 'raise'

function showBetDialog(actionType) {
  currentActionType = actionType;
  document.getElementById('betDialog').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
  
  if (actionType === 'bet') {
    document.querySelector('#betDialog h3').textContent = '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É';
    document.getElementById('minBetAmount').textContent = '20';
  } else {
    document.querySelector('#betDialog h3').textContent = '–°–¥–µ–ª–∞—Ç—å —Ä–µ–π–∑';
    if (lastState) {
      document.getElementById('minBetAmount').textContent = lastState.currentBet + (lastState.minRaise || 20);
    }
  }
}

function hideBetDialog() {
  document.getElementById('betDialog').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
}

function placeBetOrRaise() {
  const amount = parseInt(document.getElementById('betInput').value);
  if (!amount || isNaN(amount)) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
    return;
  }
  
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: currentActionType, amount: amount }
  });
  
  hideBetDialog();
}

/* ---------- SOCKET EVENTS ---------- */

socket.on('room_joined', r => {
  room = r;
  renderRoom();
});

socket.on('room_update', r => {
  room = r;
  if (!lastState) renderRoom();
});

socket.on('game_started', ({ publicState }) => {
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–≤–æ–∏ –∫–∞—Ä—Ç—ã
  socket.emit('get_my_cards', {
    code: room.code,
    playerId: me.id
  });
  renderGame(publicState);
});

socket.on('game_update', state => {
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à–∏ —Ñ–∏—à–∫–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
  const myPlayer = state.players.find(p => p.id === me.id);
  if (myPlayer) {
    me.chips = myPlayer.chips;
  }
  
  renderGame(state);
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ —ç—Ç–æ –Ω–∞—à —Ö–æ–¥
  if (state.currentPlayerId === me.id && !state.finished) {
    socket.emit('get_my_private_state', {
      code: room.code,
      playerId: me.id
    });
  }
});

socket.on('my_cards', cards => {
  myCards = cards;
  if (lastState) renderGame(lastState);
});

socket.on('my_private_state', privateState => {
  myPrivateState = privateState;
  if (lastState) renderGame(lastState);
});

socket.on('error_msg', msg => alert(msg));

renderLobby();
</script>

</body>
</html>