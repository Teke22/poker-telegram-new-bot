<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Poker</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
button {
  padding:10px;
  margin:5px;
}
input {
  padding:6px;
  margin:5px;
  width:80px;
}
.card {
  background:#fff;
  color:#000;
  padding:8px;
  margin:4px;
  border-radius:6px;
  display:inline-block;
}
.box {
  border:1px solid #fff;
  padding:10px;
  margin-top:10px;
}
</style>
</head>

<body>

<!-- üîî STATUS -->
<div id="status" style="margin-bottom:10px;font-weight:bold;"></div>

<div id="app"></div>

<script>
const tg = window.Telegram?.WebApp;

/* ---------- USER ---------- */

let me;
if (tg && tg.initDataUnsafe?.user) {
  me = tg.initDataUnsafe.user;
} else {
  me = { id: 'debug', first_name: 'Debug' };
}

/* ---------- SOCKET ---------- */

const socket = io({
  transports: ['websocket']
});

/* ---------- STATE ---------- */

let room = null;
let myCards = [];
let gameStarted = false;
let statusMessage = '';
let lastState = null;

/* ---------- UI ---------- */

function showLobby() {
  document.getElementById('status').innerText = '';
  document.getElementById('app').innerHTML = `
    <h2>Poker Lobby</h2>
    <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    <br><br>
    <input id="code" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
    <button onclick="joinRoom()">–í–æ–π—Ç–∏</button>
  `;
}

function showRoom() {
  document.getElementById('status').innerText = statusMessage;
  document.getElementById('app').innerHTML = `
    <h2>–ö–æ–º–Ω–∞—Ç–∞</h2>
    <p><b>–ö–æ–¥:</b> ${room.code}</p>

    <div class="box">
      <h3>–ò–≥—Ä–æ–∫–∏</h3>
      <ul>
        ${room.players.map(p => `<li>${p.name}</li>`).join('')}
      </ul>
    </div>

    ${room.players.length >= 2 ? `
      <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    ` : `<p>–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞‚Ä¶</p>`}
  `;
}

function renderGame(state) {
  lastState = state;
  document.getElementById('status').innerText = statusMessage;

  gameStarted = true;
  const current = state.players.find(p => p.id === state.currentPlayerId);
  const meState = state.players.find(p => p.id === me.id);

  document.getElementById('app').innerHTML = `
    <h2>–ò–≥—Ä–∞</h2>

    <p>üí∞ –ë–∞–Ω–∫: <b>${state.pot}</b></p>
    <p>üíµ –¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: <b>${state.currentBet}</b></p>
    <p>–•–æ–¥: <b>${current.name}</b></p>

    <ul>
      ${state.players.map(p =>
        `<li>${p.name} ${p.folded ? '(fold)' : ''} ‚Äî üíµ ${p.chips}</li>`
      ).join('')}
    </ul>

    <h3>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
    ${myCards.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('')}

    <br><br>

    ${state.currentPlayerId === me.id ? renderActions(state, meState) : '<p>–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞...</p>'}
  `;
}

function renderActions(state, meState) {
  if (meState.folded) return '<p>–í—ã —Å–±—Ä–æ—Å–∏–ª–∏ –∫–∞—Ä—Ç—ã</p>';

  if (state.currentBet === 0) {
    return `
      <input id="betAmount" type="number" min="1" placeholder="Bet">
      <br>
      <button onclick="bet()">Bet</button>
      <button onclick="act('check')">Check</button>
      <button onclick="act('fold')">Fold</button>
    `;
  }

  const toCall = state.currentBet - (meState.bet || 0);

  return `
    <p>–ù—É–∂–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å: ${toCall}</p>
    <input id="raiseAmount" type="number" min="${state.currentBet + 1}" placeholder="Raise to">
    <br>
    <button onclick="call()">Call</button>
    <button onclick="raise()">Raise</button>
    <button onclick="act('fold')">Fold</button>
  `;
}

/* ---------- ACTIONS ---------- */

function createRoom() {
  socket.emit('create_room', { user: me });
}

function joinRoom() {
  const code = document.getElementById('code').value.toUpperCase();
  socket.emit('join_room', { code, user: me });
}

function startGame() {
  socket.emit('start_game', { code: room.code });
}

function act(action) {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action
  });
}

function bet() {
  const amount = Number(document.getElementById('betAmount').value);
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'bet', amount }
  });
}

function call() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'call' }
  });
}

function raise() {
  const amount = Number(document.getElementById('raiseAmount').value);
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'raise', amount }
  });
}

/* ---------- SOCKET EVENTS ---------- */

socket.on('room_joined', r => {
  room = r;
  showRoom();
});

socket.on('room_update', r => {
  room = r;
  if (!gameStarted) showRoom();
});

socket.on('game_started', ({ publicState }) => {
  statusMessage = '';
  document.getElementById('status').innerText = '';
  socket.emit('get_my_cards', { code: room.code, playerId: me.id });
  renderGame(publicState);
});

socket.on('game_update', renderGame);

socket.on('hand_finished', ({ winner }) => {
  statusMessage = winner
    ? `üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner.name}`
    : 'üèÅ –†—É–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';

  document.getElementById('status').innerText = statusMessage;
});

socket.on('my_cards', cards => myCards = cards);
socket.on('error_msg', alert);

/* ---------- START ---------- */

showLobby();
</script>
</body>
</html>
