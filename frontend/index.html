<script>
const socket = io({ transports: ['websocket'] });

const me = {
  id: 'u_' + Math.random().toString(36).slice(2, 11),
  name: 'Player_' + Math.floor(Math.random() * 1000),
  chips: 1000
};

let room = null;
let myCards = [];
let myPrivateState = null;
let lastState = null;
let showDebug = false;

/* ---------- UI RENDERERS ---------- */

function renderLobby() {
  document.getElementById('app').innerHTML = `
    <div class="lobby">
      <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–æ–∫–µ—Ä!</h2>
      <p>–í–∞—à ID: <strong>${me.id}</strong></p>
      <p>–§–∏—à–∫–∏: <strong>${me.chips}</strong></p>
      <div style="margin: 30px 0;">
        <button onclick="createRoom()" style="padding: 15px 30px; font-size: 1.2em;">
          üéÆ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
        </button>
      </div>
      <div>
        <input id="code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" />
        <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
      </div>
    </div>
  `;
  document.getElementById('playerInfo').innerHTML = '';
}

function renderRoom() {
  if (!room) return;
  
  document.getElementById('app').innerHTML = `
    <div class="game-board">
      <div class="main-game">
        <h2>–ö–æ–º–Ω–∞—Ç–∞: <span style="color:#f1c40f">${room.code}</span></h2>
        
        <div class="status-bar">
          <span>–ò–≥—Ä–æ–∫–æ–≤: <strong>${room.players.length}</strong></span>
          <span>ID –∫–æ–º–Ω–∞—Ç—ã: <strong>${room.id}</strong></span>
        </div>
        
        <h3>üë• –ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ</h3>
        <ul class="player-list">
          ${room.players.map((p, idx) => `
            <li class="player-item">
              <div class="player-info">
                <span>
                  ${p.name} 
                  ${idx === 0 ? '<span class="badge badge-dealer">D</span>' : ''}
                  <span class="badge" style="background:#${p.id === me.id ? '2ecc71' : '3498db'}">
                    ${p.id === me.id ? '–í—ã' : '–ò–≥—Ä–æ–∫'}
                  </span>
                </span>
                <span class="player-chips">${p.chips} —Ñ–∏—à–µ–∫</span>
              </div>
            </li>
          `).join('')}
        </ul>
        
        <div class="actions">
          <button onclick="startGame()" ${room.players.length < 2 ? 'disabled' : ''}>
            üéØ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
          </button>
          <button onclick="leaveRoom()" style="background:#e74c3c">
            üö™ –í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
          </button>
        </div>
      </div>
      
      <div class="side-panel">
        <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <p>–ë–ª–∞–π–Ω–¥—ã: ${room.smallBlind || 10}/${room.bigBlind || 20}</p>
        <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫: ${room.minBuyin || 100}</p>
        <p>–ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤: ${room.maxPlayers || 9}</p>
        
        <h3>üìã –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</h3>
        <div style="background:#2c3e50; padding:15px; border-radius:8px; text-align:center;">
          <h2 style="margin:0; color:#f1c40f">${room.code}</h2>
          <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏</p>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('playerInfo').innerHTML = `
    <p>–í—ã: <strong>${me.name}</strong> | ID: ${me.id} | –§–∏—à–∫–∏: ${me.chips}</p>
  `;
}

function renderGame(state) {
  lastState = state;
  
  const isMyTurn = state.currentPlayerId === me.id && !state.finished;
  
  document.getElementById('app').innerHTML = `
    <div class="game-board">
      <div class="main-game">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —Ä–∞—É–Ω–¥–µ -->
        <div class="status-bar">
          <span>–°—Ç–∞–¥–∏—è: <strong class="stage-indicator">${getStageName(state.stage)}</strong></span>
          <span>–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: <strong style="color:#e74c3c">${state.currentBet}</strong></span>
          <span>–ú–∏–Ω. —Ä–µ–π–∑: <strong style="color:#f39c12">${state.minRaise || state.lastRaise || 20}</strong></span>
        </div>
        
        <!-- –ö–∞—Ä—Ç—ã —Å—Ç–æ–ª–∞ -->
        <div class="community-cards">
          <h3>–ö–∞—Ä—Ç—ã –Ω–∞ —Å—Ç–æ–ª–µ</h3>
          ${state.communityCards.length > 0 
            ? state.communityCards.map(c => renderCard(c)).join('')
            : '<p>–ö–∞—Ä—Ç—ã –µ—â–µ –Ω–µ –≤—ã–ª–æ–∂–µ–Ω—ã</p>'
          }
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–Ω–∫–∞—Ö -->
        <div class="pot-info">
          <div>
            <div>–û—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫</div>
            <div class="pot-amount">${state.pot}</div>
          </div>
          ${state.sidePots && state.sidePots.length > 0 ? `
            <div>
              <div>Side Pots</div>
              ${state.sidePots.map((pot, i) => `
                <div class="side-pot">
                  <small>Side Pot ${i+1}:</small>
                  <div><strong>${pot.amount}</strong></div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
        
        <!-- –í–∞—à–∏ –∫–∞—Ä—Ç—ã -->
        <div style="background:rgba(46,204,113,0.1); padding:15px; border-radius:8px; margin:15px 0;">
          <h3>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
          ${myCards.length > 0 
            ? myCards.map(c => renderCard(c)).join('')
            : '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>'
          }
          ${myPrivateState ? `
            <div style="margin-top:10px; font-size:0.9em;">
              <span>–ù—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å: <strong>${myPrivateState.toCall || 0}</strong></span> |
              <span>–§–∏—à–µ–∫: <strong>${myPrivateState.chips || 0}</strong></span>
            </div>
          ` : ''}
        </div>
        
        <!-- –ò–≥—Ä–æ–∫–∏ -->
        <h3>–ò–≥—Ä–æ–∫–∏ –∑–∞ —Å—Ç–æ–ª–æ–º</h3>
        <ul class="player-list">
          ${state.players.map((p, idx) => {
            const isCurrent = p.id === state.currentPlayerId;
            const isDealer = idx === state.dealerIndex;
            const isSB = idx === state.sbIndex;
            const isBB = idx === state.bbIndex;
            
            return `
              <li class="player-item ${isCurrent ? 'current-turn' : ''} ${p.folded ? 'folded' : ''}">
                <div class="player-info">
                  <div>
                    <strong>${p.name}</strong>
                    ${isDealer ? '<span class="badge badge-dealer">D</span>' : ''}
                    ${isSB ? '<span class="badge badge-sb">SB</span>' : ''}
                    ${isBB ? '<span class="badge badge-bb">BB</span>' : ''}
                    ${p.allIn ? '<span class="badge badge-allin">ALL-IN</span>' : ''}
                    ${p.folded ? '<span class="badge badge-folded">FOLD</span>' : ''}
                    ${p.id === me.id ? '<span class="badge" style="background:#2ecc71">–í—ã</span>' : ''}
                    ${isCurrent ? '<span style="color:#2ecc71"> ‚Æï –•–û–î–ò–¢</span>' : ''}
                  </div>
                  <div>
                    <span class="player-chips">${p.chips}</span>
                    ${p.bet > 0 ? `<span class="player-bet">+${p.bet}</span>` : ''}
                  </div>
                </div>
                
                ${(state.finished || p.folded) && p.showHand && p.showHand.length > 0 ? `
                  <div style="margin-top:8px;">
                    –ö–∞—Ä—Ç—ã: ${p.showHand.map(c => renderCard(c)).join('')}
                    ${p.handRank ? `<small style="color:#95a5a6"> (${p.handRank})</small>` : ''}
                  </div>
                ` : ''}
                
                ${p.contributedToPot > 0 ? `
                  <div style="font-size:0.8em; color:#95a5a6; margin-top:5px;">
                    –í–ª–æ–∂–∏–ª –≤ –±–∞–Ω–∫: ${p.contributedToPot}
                  </div>
                ` : ''}
              </li>
            `;
          }).join('')}
        </ul>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        ${!state.finished && isMyTurn ? renderActionButtons() : ''}
        
        ${state.finished ? renderWinners(state) : ''}
      </div>
      
      <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
      <div class="side-panel">
        <h3>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π</h3>
        <div class="actions">
          <button onclick="showDebugInfo()" class="debug-toggle">
            ${showDebug ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å'} Debug
          </button>
          ${state.finished ? `
            <button onclick="newHand()" style="background:#9b59b6">
              –ù–æ–≤–∞—è —Ä–∞–∑–¥–∞—á–∞
            </button>
          ` : ''}
        </div>
        
        <h3>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã</h3>
        <p>–°—Ç–∞–¥–∏—è: <strong>${state.stage}</strong></p>
        <p>–¢–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫: <strong>${state.players.find(p => p.id === state.currentPlayerId)?.name || '–ù–µ—Ç'}</strong></p>
        <p>–î–∏–ª–µ—Ä: <strong>${state.players[state.dealerIndex]?.name || '–ù–µ—Ç'}</strong></p>
        <p>SB: <strong>${state.players[state.sbIndex]?.name || '–ù–µ—Ç'}</strong></p>
        <p>BB: <strong>${state.players[state.bbIndex]?.name || '–ù–µ—Ç'}</strong></p>
        
        <h3>üí∞ –ë–∞–Ω–∫–∏</h3>
        <p>–û—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫: <strong>${state.pot}</strong></p>
        <p>Side pots: <strong>${state.sidePots?.length || 0}</strong></p>
        ${state.sidePots && state.sidePots.length > 0 ? `
          <div style="font-size:0.9em;">
            ${state.sidePots.map((pot, i) => `
              <div>Side ${i+1}: ${pot.amount}</div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    </div>
    
    <!-- –î–∏–∞–ª–æ–≥–∏ –¥–ª—è —Å—Ç–∞–≤–æ–∫ -->
    <div id="actionDialogs" style="display:none;">
      <!-- –ë–µ—Ç –¥–∏–∞–ª–æ–≥ -->
      <div id="betDialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#2c3e50; padding:20px; border-radius:10px; z-index:1000; box-shadow:0 0 20px rgba(0,0,0,0.5);">
        <h3>–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</h3>
        <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: <span id="minBet">20</span></p>
        <p>–í–∞—à–∏ —Ñ–∏—à–∫–∏: <span id="maxBet">${me.chips}</span></p>
        <input type="number" id="betAmount" min="20" max="${me.chips}" value="20" style="padding:10px; width:150px; font-size:16px;">
        <div style="margin-top:15px;">
          <button onclick="placeBet()" style="background:#2ecc71; padding:10px 20px;">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
          <button onclick="hideBetDialog()" style="background:#7f8c8d; padding:10px 20px; margin-left:10px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
      
      <!-- –†–µ–π–∑ –¥–∏–∞–ª–æ–≥ -->
      <div id="raiseDialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#2c3e50; padding:20px; border-radius:10px; z-index:1000; box-shadow:0 0 20px rgba(0,0,0,0.5);">
        <h3>–°–¥–µ–ª–∞—Ç—å —Ä–µ–π–∑</h3>
        <p>–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: <span id="currentBetAmount">${state.currentBet}</span></p>
        <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π–∑: <span id="minRaiseAmount">${state.currentBet + (state.minRaise || 20)}</span></p>
        <p>–í–∞—à–∏ —Ñ–∏—à–∫–∏: <span id="maxRaise">${me.chips}</span></p>
        <input type="number" id="raiseAmount" min="${state.currentBet + (state.minRaise || 20)}" max="${me.chips}" 
               value="${state.currentBet + (state.minRaise || 20)}" style="padding:10px; width:150px; font-size:16px;">
        <div style="margin-top:15px;">
          <button onclick="placeRaise()" style="background:#f39c12; padding:10px 20px;">–†–µ–π–∑</button>
          <button onclick="hideRaiseDialog()" style="background:#7f8c8d; padding:10px 20px; margin-left:10px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
    
    <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ -->
    <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:999;"></div>
  `;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ –æ–± –∏–≥—Ä–æ–∫–µ
  document.getElementById('playerInfo').innerHTML = `
    <div style="display:flex; justify-content:space-between;">
      <div>
        –í—ã: <strong>${me.name}</strong> | 
        –§–∏—à–∫–∏: <strong style="color:#f1c40f">${me.chips}</strong>
        ${myPrivateState ? ` | –ü–æ—Å—Ç–∞–≤–∏—Ç—å: <strong>${myPrivateState.toCall || 0}</strong>` : ''}
      </div>
      <div>
        ${room ? `–ö–æ–º–Ω–∞—Ç–∞: ${room.code}` : ''}
      </div>
    </div>
  `;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
  if (showDebug) {
    document.getElementById('debugPanel').style.display = 'block';
    document.getElementById('debugOutput').textContent = JSON.stringify(state, null, 2);
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –¥–∏–∞–ª–æ–≥–∞—Ö
  if (document.getElementById('minRaiseAmount')) {
    document.getElementById('minRaiseAmount').textContent = state.currentBet + (state.minRaise || 20);
    document.getElementById('currentBetAmount').textContent = state.currentBet;
  }
  
  // –ï—Å–ª–∏ –Ω–∞—à–∞ –æ—á–µ—Ä–µ–¥—å, –Ω–æ –Ω–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –µ–≥–æ
  if (isMyTurn && (!myPrivateState || Object.keys(myPrivateState).length === 0)) {
    console.log('–ù–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º...');
    requestPrivateState();
  }
}

function getStageName(stage) {
  const names = {
    'preflop': '–ü—Ä–µ—Ñ–ª–æ–ø',
    'flop': '–§–ª–æ–ø',
    'turn': '–¢—ë—Ä–Ω',
    'river': '–†–∏–≤–µ—Ä',
    'showdown': '–®–æ—É–¥–∞—É–Ω'
  };
  return names[stage] || stage;
}

function renderCard(card) {
  if (!card) return '';
  const suit = card.suit.toLowerCase();
  const suitSymbols = {
    's': '‚ô†',
    'h': '‚ô•', 
    'd': '‚ô¶',
    'c': '‚ô£'
  };
  const suitClasses = {
    's': 'spades',
    'h': 'hearts',
    'd': 'diamonds',
    'c': 'clubs'
  };
  
  return `
    <span class="card ${suitClasses[suit] || ''}">
      ${card.rank}${suitSymbols[suit] || suit}
    </span>
  `;
}

function renderActionButtons() {
  console.log('Rendering action buttons, myPrivateState:', myPrivateState);
  console.log('Current state:', lastState);
  
  if (!myPrivateState || Object.keys(myPrivateState).length === 0) {
    console.log('No private state available');
    return '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π...</p>';
  }
  
  const toCall = myPrivateState.toCall || 0;
  const myChips = myPrivateState.chips || 0;
  const currentBet = lastState.currentBet || 0;
  
  console.log('Action params:', { toCall, myChips, currentBet, myPrivateState });
  
  const canCheck = toCall === 0;
  const canCall = toCall > 0 && myChips >= toCall;
  const canBet = currentBet === 0 && myChips > 0; // –ë–µ—Ç –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ —Å—Ç–∞–≤–∏–ª
  const canRaise = myChips > toCall && toCall < myChips;
  const isAllIn = myPrivateState.isAllIn || false;
  
  console.log('Available actions:', { canCheck, canCall, canBet, canRaise, isAllIn });
  
  return `
    <div class="actions">
      <h3>–í–∞—à —Ö–æ–¥</h3>
      <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:5px; margin-bottom:10px;">
        ${toCall > 0 ? `–ù—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å: <strong>${toCall}</strong> —á—Ç–æ–±—ã –∫–æ–ª–ª–∏—Ä–æ–≤–∞—Ç—å` : '–í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —á–µ–∫'}
      </div>
      
      <!-- –§–æ–ª–¥ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω–µ all-in -->
      <button onclick="fold()" class="fold" ${isAllIn ? 'disabled' : ''}>
        –§–æ–ª–¥
      </button>
      
      <!-- –ß–µ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –∫–æ–ª–ª–∏—Ç—å -->
      ${canCheck ? `
        <button onclick="check()" class="call">
          –ß–µ–∫
        </button>
      ` : ''}
      
      <!-- –ö–æ–ª–ª –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å -->
      ${canCall ? `
        <button onclick="call()" class="call">
          –ö–æ–ª–ª (${toCall})
        </button>
      ` : ''}
      
      <!-- –ë–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –µ—â–µ –Ω–µ —Å—Ç–∞–≤–∏–ª –Ω–∞ —ç—Ç–æ–π —É–ª–∏—Ü–µ -->
      ${canBet ? `
        <button onclick="showBetDialog()" class="raise">
          –ë–µ—Ç
        </button>
      ` : ''}
      
      <!-- –†–µ–π–∑ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å —Ñ–∏—à–∫–∏ –¥–ª—è —Ä–µ–π–∑–∞ -->
      ${canRaise ? `
        <button onclick="showRaiseDialog()" class="raise">
          –†–µ–π–∑
        </button>
      ` : ''}
      
      <!-- All-in –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏—à–∫–∏ -->
      ${!isAllIn && myChips > 0 ? `
        <button onclick="goAllIn()" class="allin">
          ALL-IN (${myChips})
        </button>
      ` : ''}
    </div>
  `;
}

function renderWinners(state) {
  if (!state.finished || !state.winners?.length) return '';
  
  return `
    <div class="winner-section">
      <h2>üèÜ –ü–û–ë–ï–î–ò–¢–ï–õ–¨${state.winners.length > 1 ? '–ò' : ''} üèÜ</h2>
      <p><strong>–õ—É—á—à–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è:</strong> ${state.winningHandName || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}</p>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
        ${state.winners.map(winner => {
          const player = state.players.find(p => p.id === winner.id);
          return `
            <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:8px;">
              <h3 style="margin-top:0;">${player?.name || winner.name}</h3>
              ${player?.handRank ? `<p>–ö–æ–º–±–∏–Ω–∞—Ü–∏—è: <strong>${player.handRank}</strong></p>` : ''}
              <p>–í—ã–∏–≥—Ä—ã—à: <strong style="color:#f1c40f">???</strong></p>
            </div>
          `;
        }).join('')}
      </div>
      
      <p style="font-size:0.9em; opacity:0.8;">–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Ä–∞–∑–¥–∞—á—É...</p>
    </div>
  `;
}

/* ---------- ACTIONS ---------- */

function createRoom() {
  socket.emit('create_room', { user: me });
}

function joinRoom() {
  const code = document.getElementById('code').value.trim();
  if (!code) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
    return;
  }
  socket.emit('join_room', { code, user: me });
}

function leaveRoom() {
  if (!room) return;
  socket.emit('leave_room', { code: room.code, playerId: me.id });
  room = null;
  myCards = [];
  myPrivateState = null;
  renderLobby();
}

function startGame() {
  if (!room) return;
  socket.emit('start_game', { code: room.code });
}

function newHand() {
  if (!room) return;
  socket.emit('new_hand', { code: room.code });
}

function check() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'check'
  });
}

function call() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'call' }
  });
}

function fold() {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –∫–∞—Ä—Ç—ã?')) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'fold'
  });
}

function goAllIn() {
  if (!myPrivateState || myPrivateState.chips <= 0) return;
  if (!confirm(`–ü–æ–π—Ç–∏ ALL-IN –Ω–∞ ${myPrivateState.chips} —Ñ–∏—à–µ–∫?`)) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'allin' }
  });
}

function showBetDialog() {
  document.getElementById('betDialog').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('actionDialogs').style.display = 'block';
}

function hideBetDialog() {
  document.getElementById('betDialog').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
}

function placeBet() {
  const amount = parseInt(document.getElementById('betAmount').value);
  if (!amount || isNaN(amount)) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
    return;
  }
  
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'bet', amount: amount }
  });
  
  hideBetDialog();
}

function showRaiseDialog() {
  document.getElementById('raiseDialog').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('actionDialogs').style.display = 'block';
}

function hideRaiseDialog() {
  document.getElementById('raiseDialog').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
}

function placeRaise() {
  const amount = parseInt(document.getElementById('raiseAmount').value);
  if (!amount || isNaN(amount)) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
    return;
  }
  
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'raise', amount: amount }
  });
  
  hideRaiseDialog();
}

function showDebugInfo() {
  showDebug = !showDebug;
  if (lastState) renderGame(lastState);
}

function requestPrivateState() {
  if (!room || !me.id) return;
  
  console.log('Requesting private state for player:', me.id);
  socket.emit('get_my_private_state', {
    code: room.code,
    playerId: me.id
  });
}

/* ---------- SOCKET EVENTS ---------- */

socket.on('room_joined', r => {
  console.log('Room joined:', r);
  room = r;
  const myPlayer = r.players.find(p => p.id === me.id);
  if (myPlayer) {
    me.chips = myPlayer.chips;
    me.name = myPlayer.name;
  }
  renderRoom();
});

socket.on('room_update', r => {
  console.log('Room updated:', r);
  room = r;
  const myPlayer = r.players.find(p => p.id === me.id);
  if (myPlayer) {
    me.chips = myPlayer.chips;
    me.name = myPlayer.name;
  }
  if (!lastState) renderRoom();
});

socket.on('game_started', ({ publicState }) => {
  console.log('Game started:', publicState);
  myCards = [];
  myPrivateState = null;
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–≤–æ–∏ –∫–∞—Ä—Ç—ã
  setTimeout(() => {
    socket.emit('get_my_cards', {
      code: room.code,
      playerId: me.id
    });
  }, 500);
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  setTimeout(() => {
    requestPrivateState();
  }, 800);
  
  renderGame(publicState);
});

socket.on('game_update', state => {
  console.log('Game updated:', state);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–∏ —Ñ–∏—à–∫–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const myPlayer = state.players.find(p => p.id === me.id);
  if (myPlayer) {
    me.chips = myPlayer.chips;
    me.name = myPlayer.name;
  }
  
  renderGame(state);
  
  // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–∞—à —Ö–æ–¥ - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  if (state.currentPlayerId === me.id && !state.finished) {
    setTimeout(() => {
      requestPrivateState();
    }, 300);
  }
});

socket.on('my_cards', cards => {
  console.log('Received my cards:', cards);
  myCards = cards;
  if (lastState) renderGame(lastState);
});

socket.on('my_private_state', privateState => {
  console.log('Received private state:', privateState);
  myPrivateState = privateState;
  
  // –ï—Å–ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç chips, –æ–±–Ω–æ–≤–ª—è–µ–º me.chips
  if (privateState && privateState.chips !== undefined) {
    me.chips = privateState.chips;
  }
  
  if (lastState) {
    console.log('Re-rendering with private state');
    renderGame(lastState);
  }
});

socket.on('error_msg', msg => {
  console.error('Error:', msg);
  alert('–û—à–∏–±–∫–∞: ' + msg);
});

socket.on('player_left', data => {
  console.log('Player left:', data);
  alert(`–ò–≥—Ä–æ–∫ ${data.playerName} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
console.log('Initializing with player:', me);
renderLobby();
</script>