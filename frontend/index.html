<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Poker</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
button {
  padding:10px;
  margin:5px;
}
.card {
  background:#fff;
  color:#000;
  padding:8px;
  margin:4px;
  border-radius:6px;
  display:inline-block;
}
.box {
  border:1px solid #fff;
  padding:10px;
  margin-top:10px;
}
</style>
</head>

<body>
<div id="app"></div>

<script>
const tg = window.Telegram?.WebApp;

/* ---------- USER ---------- */

let me;
if (tg && tg.initDataUnsafe?.user) {
  me = tg.initDataUnsafe.user;
} else {
  me = { id: 'debug', first_name: 'Debug' };
}

/* ---------- SOCKET ---------- */

const socket = io({
  transports: ['websocket']
});

/* ---------- STATE ---------- */

let room = null;
let myCards = [];
let gameStarted = false;

/* ---------- UI ---------- */

function showLobby() {
  document.getElementById('app').innerHTML = `
    <h2>Poker Lobby</h2>
    <button onclick="createRoom()">Создать комнату</button>
    <br><br>
    <input id="code" placeholder="Код комнаты">
    <button onclick="joinRoom()">Войти</button>
  `;
}

function showRoom() {
  document.getElementById('app').innerHTML = `
    <h2>Комната</h2>
    <p><b>Код:</b> ${room.code}</p>

    <div class="box">
      <h3>Игроки</h3>
      <ul>
        ${room.players.map(p => `<li>${p.name}</li>`).join('')}
      </ul>
    </div>

    ${room.players.length >= 2 ? `
      <button onclick="startGame()">Начать игру</button>
    ` : `<p>Ожидание второго игрока…</p>`}
  `;
}

function renderGame(state) {
  gameStarted = true;
  const current = state.players.find(p => p.id === state.currentPlayerId);

  document.getElementById('app').innerHTML = `
    <h2>Игра началась</h2>
    <p>Ход: <b>${current.name}</b></p>

    <ul>
      ${state.players.map(p =>
        `<li>${p.name} ${p.folded ? '(fold)' : ''}</li>`
      ).join('')}
    </ul>

    <h3>Ваши карты</h3>
    ${myCards.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('')}

    <br><br>

    ${state.currentPlayerId === me.id ? `
      <button onclick="act('check')">Check</button>
      <button onclick="act('fold')">Fold</button>
    ` : '<p>Ожидание хода...</p>'}
  `;
}

/* ---------- ACTIONS ---------- */

function createRoom() {
  socket.emit('create_room', { user: me });
}

function joinRoom() {
  const code = document.getElementById('code').value.toUpperCase();
  socket.emit('join_room', { code, user: me });
}

function startGame() {
  socket.emit('start_game', { code: room.code });
}

function act(action) {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action
  });
}

/* ---------- SOCKET EVENTS ---------- */

socket.on('room_joined', r => {
  room = r;
  showRoom();
});

socket.on('room_update', r => {
  room = r;
  if (!gameStarted) showRoom();
});

socket.on('game_started', ({ publicState }) => {
  socket.emit('get_my_cards', { code: room.code, playerId: me.id });
  renderGame(publicState);
});

socket.on('game_update', renderGame);
socket.on('my_cards', cards => myCards = cards);
socket.on('error_msg', alert);

/* ---------- START ---------- */

showLobby();
</script>
</body>
</html>
