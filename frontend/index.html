<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Poker</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  padding:20px;
  margin:0;
}
button {
  padding:10px 15px;
  margin:5px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-weight:bold;
  min-width:80px;
}
button:hover {
  opacity:0.9;
}
button:disabled {
  background:#666 !important;
  cursor:not-allowed;
  opacity:0.5;
}
.card {
  background:#fff;
  color:#000;
  padding:8px 10px;
  margin:4px;
  border-radius:6px;
  display:inline-block;
  font-weight:bold;
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.box {
  border:1px solid #2ecc71;
  padding:15px;
  margin:10px 0;
  border-radius:8px;
  background:rgba(0,0,0,0.2);
}
.status {
  padding:10px;
  background:#2c3e50;
  border-radius:5px;
  margin-bottom:15px;
  font-weight:bold;
}
.player {
  padding:8px;
  margin:5px 0;
  background:rgba(255,255,255,0.1);
  border-radius:5px;
}
.current-player {
  background:rgba(46, 204, 113, 0.2);
  border-left:4px solid #2ecc71;
}
.folded {
  opacity:0.5;
}
.allin {
  color:#f39c12;
}
.bet-input {
  padding:8px;
  margin:5px;
  width:80px;
  border-radius:5px;
  border:1px solid #ccc;
}
.actions {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin:15px 0;
}
.action-btn {
  flex:1;
  min-width:100px;
}
.btn-fold { background:#e74c3c; color:white; }
.btn-check { background:#27ae60; color:white; }
.btn-call { background:#3498db; color:white; }
.btn-bet { background:#f39c12; color:white; }
.btn-raise { background:#e67e22; color:white; }
.btn-allin { background:#9b59b6; color:white; }
</style>
</head>

<body>

<div id="status" class="status"></div>
<div id="app"></div>

<script>
const tg = window.Telegram?.WebApp;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
let me;
if (tg && tg.initDataUnsafe?.user) {
  me = {
    id: String(tg.initDataUnsafe.user.id),
    name: tg.initDataUnsafe.user.first_name || 'Player',
    chips: 1000
  };
} else {
  me = {
    id: 'debug_' + Math.random().toString(36).substr(2, 9),
    name: 'DebugPlayer',
    chips: 1000
  };
}

const socket = io({ transports: ['websocket'] });

let room = null;
let myCards = [];
let gameState = null;
let myPrivateState = null;

// ============= UI FUNCTIONS =============

function showLobby() {
  document.getElementById('app').innerHTML = `
    <div class="box">
      <h2>üé¥ Poker Lobby</h2>
      <p>–í–∞—à ID: ${me.id}</p>
      <p>–§–∏—à–∫–∏: ${me.chips}</p>
      
      <div style="margin:20px 0;">
        <button onclick="createRoom()" style="background:#f39c12; padding:12px 20px; font-size:16px;">
          üéÆ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
        </button>
      </div>
      
      <div style="margin:20px 0;">
        <h3>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è:</h3>
        <input id="code" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" style="padding:10px; width:150px;">
        <button onclick="joinRoom()" style="background:#27ae60; padding:10px 20px;">
          –í–æ–π—Ç–∏
        </button>
      </div>
    </div>
  `;
  updateStatus('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–æ–∫–µ—Ä!');
}

function showRoom() {
  if (!room) return;
  
  document.getElementById('app').innerHTML = `
    <div class="box">
      <h2>üéØ –ö–æ–º–Ω–∞—Ç–∞: ${room.code}</h2>
      <p>–ö–æ–¥ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: <strong>${room.code}</strong></p>
      
      <h3>üë• –ò–≥—Ä–æ–∫–∏ (${room.players.length})</h3>
      ${room.players.map(p => `
        <div class="player">
          ${p.name} - üí∞ ${p.chips} —Ñ–∏—à–µ–∫
          ${p.id === me.id ? ' (–í—ã)' : ''}
        </div>
      `).join('')}
      
      <div style="margin-top:20px;">
        ${room.players.length >= 2 ? `
          <button onclick="startGame()" style="background:#27ae60; padding:12px 24px; font-size:16px;">
            üéØ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
          </button>
        ` : `
          <p>‚è≥ –û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</p>
        `}
        
        <button onclick="leaveRoom()" style="background:#e74c3c; margin-left:10px;">
          üö™ –í—ã–π—Ç–∏
        </button>
      </div>
    </div>
  `;
  updateStatus(`–í—ã –≤ –∫–æ–º–Ω–∞—Ç–µ ${room.code}`);
}

function showGame() {
  if (!gameState) return;
  
  const isMyTurn = gameState.currentPlayerId === me.id && !gameState.finished;
  const meInGame = gameState.players.find(p => p.id === me.id);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à–∏ —Ñ–∏—à–∫–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
  if (meInGame) {
    me.chips = meInGame.chips;
  }
  
  document.getElementById('app').innerHTML = `
    <div class="box">
      <h2>üéÆ –ò–≥—Ä–∞</h2>
      <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <div>
          <strong>–°—Ç–∞–¥–∏—è:</strong> ${getStageName(gameState.stage)}<br>
          <strong>–ë–∞–Ω–∫:</strong> ${gameState.pot}<br>
          ${gameState.sidePots?.length > 0 ? `
            <strong>Side pots:</strong> ${gameState.sidePots.length}<br>
          ` : ''}
        </div>
        <div>
          <strong>–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞:</strong> ${gameState.currentBet}<br>
          <strong>–ú–∏–Ω. —Ä–µ–π–∑:</strong> ${gameState.minRaise || 20}<br>
          <strong>–•–æ–¥–∏—Ç:</strong> ${gameState.players.find(p => p.id === gameState.currentPlayerId)?.name || '?'}
        </div>
      </div>
    </div>
    
    <div class="box">
      <h3>üìä –ö–∞—Ä—Ç—ã —Å—Ç–æ–ª–∞</h3>
      ${gameState.communityCards.length > 0 
        ? gameState.communityCards.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('')
        : '<p>–ö–∞—Ä—Ç—ã –µ—â–µ –Ω–µ –≤—ã–ª–æ–∂–µ–Ω—ã</p>'
      }
    </div>
    
    <div class="box">
      <h3>üÉè –í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
      ${myCards.length > 0 
        ? myCards.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('')
        : '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>'
      }
      ${myPrivateState ? `
        <div style="margin-top:10px; font-size:0.9em;">
          <strong>–ù—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å:</strong> ${myPrivateState.toCall || 0}<br>
          <strong>–§–∏—à–µ–∫ –æ—Å—Ç–∞–ª–æ—Å—å:</strong> ${myPrivateState.chips || 0}
        </div>
      ` : ''}
    </div>
    
    <div class="box">
      <h3>üë• –ò–≥—Ä–æ–∫–∏ –∑–∞ —Å—Ç–æ–ª–æ–º</h3>
      ${gameState.players.map(p => {
        const isCurrent = p.id === gameState.currentPlayerId;
        const isDealer = gameState.players.indexOf(p) === gameState.dealerIndex;
        const isSB = gameState.players.indexOf(p) === gameState.sbIndex;
        const isBB = gameState.players.indexOf(p) === gameState.bbIndex;
        
        return `
          <div class="player ${isCurrent ? 'current-player' : ''} ${p.folded ? 'folded' : ''}">
            <div style="display:flex; justify-content:space-between;">
              <div>
                <strong>${p.name}</strong>
                ${p.id === me.id ? ' (–í—ã)' : ''}
                ${isDealer ? ' üÉè' : ''}
                ${isSB ? ' SB' : ''}
                ${isBB ? ' BB' : ''}
                ${p.folded ? ' ‚ùå' : ''}
                ${p.allIn ? ' ‚ö°' : ''}
                ${isCurrent ? ' üéØ' : ''}
              </div>
              <div>
                üí∞ ${p.chips}
                ${p.bet > 0 ? `<span style="color:#f39c12;"> (+${p.bet})</span>` : ''}
              </div>
            </div>
            ${(gameState.finished || p.folded) && p.showHand && p.showHand.length > 0 ? `
              <div style="margin-top:5px;">
                –ö–∞—Ä—Ç—ã: ${p.showHand.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('')}
    </div>
    
    <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
    ${!gameState.finished && isMyTurn ? renderActions() : ''}
    
    ${gameState.finished ? renderWinners() : ''}
    
    <div style="margin-top:20px; text-align:center;">
      <button onclick="leaveRoom()" style="background:#e74c3c;">
        üö™ –í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
      </button>
      ${gameState.finished ? `
        <button onclick="requestNewHand()" style="background:#27ae60; margin-left:10px;">
          üÉè –ù–æ–≤–∞—è —Ä–∞–∑–¥–∞—á–∞
        </button>
      ` : ''}
    </div>
    
    <!-- –î–∏–∞–ª–æ–≥ –¥–ª—è —Å—Ç–∞–≤–æ–∫ -->
    <div id="betDialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); 
         background:#2c3e50; padding:20px; border-radius:10px; z-index:1000; box-shadow:0 0 20px rgba(0,0,0,0.5);">
      <h3 id="dialogTitle">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</h3>
      <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: <span id="minAmount">20</span></p>
      <p>–í–∞—à–∏ —Ñ–∏—à–∫–∏: <span id="maxAmount">${me.chips}</span></p>
      <input type="number" id="amountInput" value="20" style="padding:10px; width:150px; font-size:16px;">
      <div style="margin-top:15px;">
        <button onclick="submitBet()" style="background:#27ae60; padding:10px 20px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button onclick="hideBetDialog()" style="background:#7f8c8d; padding:10px 20px; margin-left:10px;">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>
  `;
  
  if (isMyTurn) {
    updateStatus(`üéØ –í–∞—à —Ö–æ–¥! –°—Ç–∞–¥–∏—è: ${getStageName(gameState.stage)}`);
  } else if (gameState.finished) {
    updateStatus(`üéâ –†–∞–∑–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!`);
  } else {
    updateStatus(`‚è≥ –•–æ–¥–∏—Ç: ${gameState.players.find(p => p.id === gameState.currentPlayerId)?.name || '...'}`);
  }
}

function renderActions() {
  if (!myPrivateState) {
    return '<div class="box"><p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π...</p></div>';
  }
  
  const toCall = myPrivateState.toCall || 0;
  const canCheck = myPrivateState.canCheck && toCall === 0;
  const canCall = myPrivateState.canCall && toCall > 0;
  const canBet = myPrivateState.canBet && toCall === 0;
  const canRaise = myPrivateState.canRaise;
  const isAllIn = myPrivateState.isAllIn;
  
  console.log('Action state:', { toCall, canCheck, canCall, canBet, canRaise, isAllIn, myPrivateState });
  
  return `
    <div class="box">
      <h3>üéØ –í–∞—à —Ö–æ–¥</h3>
      ${toCall > 0 ? `<p>–ù—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å: <strong>${toCall}</strong> —á—Ç–æ–±—ã –∫–æ–ª–ª–∏—Ä–æ–≤–∞—Ç—å</p>` : ''}
      
      <div class="actions">
        <!-- –§–æ–ª–¥ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω–µ all-in -->
        <button onclick="fold()" class="action-btn btn-fold" ${isAllIn ? 'disabled' : ''}>
          ‚ùå –§–æ–ª–¥
        </button>
        
        <!-- –ß–µ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –∫–æ–ª–ª–∏—Ç—å -->
        ${canCheck ? `
          <button onclick="check()" class="action-btn btn-check">
            ‚úì –ß–µ–∫
          </button>
        ` : ''}
        
        <!-- –ö–æ–ª–ª –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å -->
        ${canCall ? `
          <button onclick="call()" class="action-btn btn-call">
            üìû –ö–æ–ª–ª (${toCall})
          </button>
        ` : ''}
        
        <!-- –ë–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –µ—â–µ –Ω–µ —Å—Ç–∞–≤–∏–ª –Ω–∞ —ç—Ç–æ–π —É–ª–∏—Ü–µ -->
        ${canBet ? `
          <button onclick="showBetDialog('bet')" class="action-btn btn-bet">
            üí∞ –ë–µ—Ç
          </button>
        ` : ''}
        
        <!-- –†–µ–π–∑ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å —Ñ–∏—à–∫–∏ –¥–ª—è —Ä–µ–π–∑–∞ -->
        ${canRaise ? `
          <button onclick="showBetDialog('raise')" class="action-btn btn-raise">
            üìà –†–µ–π–∑
          </button>
        ` : ''}
        
        <!-- All-in –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏—à–∫–∏ -->
        ${!isAllIn && myPrivateState.chips > 0 ? `
          <button onclick="allIn()" class="action-btn btn-allin">
            ‚ö° ALL-IN (${myPrivateState.chips})
          </button>
        ` : ''}
      </div>
    </div>
  `;
}

function renderWinners() {
  if (!gameState.winners || gameState.winners.length === 0) return '';
  
  return `
    <div class="box" style="background:rgba(46, 204, 113, 0.2); border-color:#2ecc71;">
      <h2>üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏</h2>
      <p><strong>–õ—É—á—à–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è:</strong> ${gameState.winningHandName || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}</p>
      
      <div style="margin:15px 0;">
        ${gameState.winners.map(winner => {
          const player = gameState.players.find(p => p.id === winner.id);
          return `
            <div class="player" style="background:rgba(46, 204, 113, 0.3);">
              <strong>${player?.name || winner.name}</strong>
              ${player?.handRank ? `<br>–ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${player.handRank}` : ''}
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

function getStageName(stage) {
  const stages = {
    'preflop': '–ü—Ä–µ—Ñ–ª–æ–ø',
    'flop': '–§–ª–æ–ø',
    'turn': '–¢—ë—Ä–Ω',
    'river': '–†–∏–≤–µ—Ä',
    'showdown': '–®–æ—É–¥–∞—É–Ω'
  };
  return stages[stage] || stage;
}

function updateStatus(text) {
  document.getElementById('status').innerText = text;
}

// ============= GAME ACTIONS =============

function createRoom() {
  socket.emit('create_room', { user: me });
}

function joinRoom() {
  const code = document.getElementById('code').value.trim().toUpperCase();
  if (!code) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
    return;
  }
  socket.emit('join_room', { code, user: me });
}

function leaveRoom() {
  if (!room) return;
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É?')) {
    socket.emit('leave_room', { code: room.code, playerId: me.id });
    room = null;
    gameState = null;
    myCards = [];
    myPrivateState = null;
    showLobby();
  }
}

function startGame() {
  if (!room) return;
  socket.emit('start_game', { code: room.code });
}

function requestNewHand() {
  if (!room) return;
  socket.emit('start_game', { code: room.code });
}

// –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–∞
function fold() {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫–∞—Ä—Ç—ã?')) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'fold'
  });
}

function check() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'check'
  });
}

function call() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'call' }
  });
}

function allIn() {
  if (!confirm(`–ü–æ–π—Ç–∏ ALL-IN –Ω–∞ ${myPrivateState?.chips || me.chips} —Ñ–∏—à–µ–∫?`)) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'allin' }
  });
}

// –î–∏–∞–ª–æ–≥ –¥–ª—è —Å—Ç–∞–≤–æ–∫/—Ä–µ–π–∑–æ–≤
let currentDialogType = 'bet';

function showBetDialog(type) {
  currentDialogType = type;
  const dialog = document.getElementById('betDialog');
  const overlay = document.getElementById('overlay');
  const input = document.getElementById('amountInput');
  
  if (type === 'bet') {
    document.getElementById('dialogTitle').textContent = '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É';
    document.getElementById('minAmount').textContent = '20';
    input.min = 20;
    input.max = myPrivateState?.chips || me.chips;
    input.value = 20;
  } else {
    document.getElementById('dialogTitle').textContent = '–°–¥–µ–ª–∞—Ç—å —Ä–µ–π–∑';
    const minRaise = myPrivateState?.minRaiseAmount || (gameState.currentBet + gameState.minRaise);
    document.getElementById('minAmount').textContent = minRaise;
    input.min = minRaise;
    input.max = myPrivateState?.maxRaiseAmount || (myPrivateState?.chips || me.chips);
    input.value = minRaise;
  }
  
  document.getElementById('maxAmount').textContent = myPrivateState?.chips || me.chips;
  dialog.style.display = 'block';
  overlay.style.display = 'block';
}

function hideBetDialog() {
  document.getElementById('betDialog').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
}

function submitBet() {
  const amount = parseInt(document.getElementById('amountInput').value);
  if (isNaN(amount) || amount <= 0) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
    return;
  }
  
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: currentDialogType, amount: amount }
  });
  
  hideBetDialog();
}

// ============= SOCKET HANDLERS =============

socket.on('connect', () => {
  console.log('Connected to server');
  updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
});

socket.on('disconnect', () => {
  updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
});

socket.on('room_joined', (r) => {
  console.log('Room joined:', r);
  room = r;
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à–∏ —Ñ–∏—à–∫–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
  const myPlayer = r.players.find(p => p.id === me.id);
  if (myPlayer) {
    me.chips = myPlayer.chips;
  }
  showRoom();
});

socket.on('room_update', (r) => {
  console.log('Room updated:', r);
  room = r;
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à–∏ —Ñ–∏—à–∫–∏
  const myPlayer = r.players.find(p => p.id === me.id);
  if (myPlayer) {
    me.chips = myPlayer.chips;
  }
  if (!gameState) {
    showRoom();
  }
});

socket.on('game_started', ({ publicState }) => {
  console.log('Game started:', publicState);
  gameState = publicState;
  myCards = [];
  myPrivateState = null;
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–≤–æ–∏ –∫–∞—Ä—Ç—ã
  setTimeout(() => {
    socket.emit('get_my_cards', {
      code: room.code,
      playerId: me.id
    });
  }, 500);
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  setTimeout(() => {
    socket.emit('get_my_private_state', {
      code: room.code,
      playerId: me.id
    });
  }, 800);
  
  showGame();
});

socket.on('game_update', (state) => {
  console.log('Game updated:', state);
  gameState = state;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à–∏ —Ñ–∏—à–∫–∏
  const myPlayer = state.players.find(p => p.id === me.id);
  if (myPlayer) {
    me.chips = myPlayer.chips;
  }
  
  showGame();
  
  // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–∞—à —Ö–æ–¥, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  if (state.currentPlayerId === me.id && !state.finished) {
    setTimeout(() => {
      socket.emit('get_my_private_state', {
        code: room.code,
        playerId: me.id
      });
    }, 300);
  }
});

socket.on('my_cards', (cards) => {
  console.log('Received my cards:', cards);
  myCards = cards;
  if (gameState) {
    showGame();
  }
});

socket.on('my_private_state', (privateState) => {
  console.log('Received private state:', privateState);
  myPrivateState = privateState;
  if (gameState) {
    showGame();
  }
});

socket.on('error_msg', (msg) => {
  console.error('Server error:', msg);
  alert('–û—à–∏–±–∫–∞: ' + msg);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
showLobby();
</script>
</body>
</html>