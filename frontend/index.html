<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Poker</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
button {
  padding:10px;
  margin:5px;
}
.card {
  background:#fff;
  color:#000;
  padding:6px;
  margin:4px;
  border-radius:6px;
  display:inline-block;
}
.winner {
  background:#1e7f5c;
  padding:10px;
  margin-top:15px;
  border-radius:8px;
}
</style>
</head>

<body>

<h1>üÉè Poker Mini App</h1>
<div id="app"></div>

<script>
const socket = io({ transports: ['websocket'] });

const me = {
  id: 'u_' + Math.random().toString(36).slice(2),
  first_name: 'Player'
};

let room = null;
let myCards = [];
let lastState = null;

/* ---------- UI ---------- */

function renderLobby() {
  document.getElementById('app').innerHTML = `
    <button onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    <br><br>
    <input id="code" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" />
    <button onclick="joinRoom()">–í–æ–π—Ç–∏</button>
  `;
}

function renderRoom() {
  document.getElementById('app').innerHTML = `
    <h2>–ö–æ–º–Ω–∞—Ç–∞ ${room.code}</h2>
    <ul>
      ${room.players.map(p => `<li>${p.name} (${p.chips})</li>`).join('')}
    </ul>
    <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    <button onclick="leaveRoom()">–í—ã–π—Ç–∏</button>
  `;
}

function renderGame(state) {
  lastState = state;

  document.getElementById('app').innerHTML = `
    <h2>–ò–≥—Ä–∞</h2>
    <p>–°—Ç–∞–¥–∏—è: ${state.stage}</p>
    <p>–ë–∞–Ω–∫: ${state.pot}</p>

    <h3>–ö–∞—Ä—Ç—ã —Å—Ç–æ–ª–∞</h3>
    ${state.communityCards.map(c =>
      `<span class="card">${c.rank}${c.suit}</span>`
    ).join('')}

    <h3>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
    ${myCards.map(c =>
      `<span class="card">${c.rank}${c.suit}</span>`
    ).join('')}

    <h3>–ò–≥—Ä–æ–∫–∏</h3>
    <ul>
      ${state.players.map(p => `
        <li>
          ${p.name} (${p.chips})
          ${p.id === state.currentPlayerId ? ' ‚¨Ö —Ö–æ–¥' : ''}
          ${state.finished
            ? `<br>${p.showHand.map(c =>
                `<span class="card">${c.rank}${c.suit}</span>`
              ).join('')}`
            : ''}
        </li>
      `).join('')}
    </ul>

    ${state.currentPlayerId === me.id && !state.finished ? `
      <button onclick="check()">–ß–µ–∫</button>
      <button onclick="call()">–ö–æ–ª–ª</button>
      <button onclick="fold()">–§–æ–ª–¥</button>
    ` : '<p>–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞...</p>'}

    ${renderWinners(state)}
  `;
}

function renderWinners(state) {
  if (!state.finished || !state.winners?.length) return '';

  return `
    <div class="winner">
      <h3>üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å${state.winners.length > 1 ? '–∏' : ''}</h3>
      <p><strong>–ö–æ–º–±–∏–Ω–∞—Ü–∏—è:</strong> ${state.winningHandName}</p>
      <ul>
        ${state.winners.map(w => `
          <li><strong>${w.name}</strong></li>
        `).join('')}
      </ul>
    </div>
  `;
}

/* ---------- ACTIONS ---------- */

function createRoom() {
  socket.emit('create_room', { user: me });
}

function joinRoom() {
  const code = document.getElementById('code').value.trim();
  socket.emit('join_room', { code, user: me });
}

function leaveRoom() {
  socket.emit('leave_room', { code: room.code, playerId: me.id });
  room = null;
  renderLobby();
}

function startGame() {
  socket.emit('start_game', { code: room.code });
}

function check() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'check'
  });
}

function call() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'call' }
  });
}

function fold() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'fold'
  });
}

/* ---------- SOCKET EVENTS ---------- */

socket.on('room_joined', r => {
  room = r;
  renderRoom();
});

socket.on('room_update', r => {
  room = r;
  if (!lastState) renderRoom();
});

socket.on('game_started', ({ publicState }) => {
  socket.emit('get_my_cards', {
    code: room.code,
    playerId: me.id
  });
  renderGame(publicState);
});

socket.on('game_update', state => {
  renderGame(state);
});

socket.on('my_cards', cards => {
  myCards = cards;
  if (lastState) renderGame(lastState);
});

socket.on('error_msg', msg => alert(msg));

renderLobby();
</script>

</body>
</html>
