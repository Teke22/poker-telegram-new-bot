<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Poker</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background: linear-gradient(135deg, #0b3d2e 0%, #1a5c48 100%);
  color:#fff;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  padding:10px;
  margin:0;
  min-height:100vh;
}
button {
  padding:12px 16px;
  margin:5px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  min-width:100px;
  font-size:14px;
  transition:all 0.3s;
  box-shadow:0 3px 6px rgba(0,0,0,0.2);
}
button:hover {
  transform:translateY(-2px);
  box-shadow:0 5px 10px rgba(0,0,0,0.3);
}
button:active {
  transform:translateY(0);
}
button:disabled {
  background:#666 !important;
  cursor:not-allowed;
  opacity:0.5;
  transform:none !important;
}
.card {
  display:inline-block;
  width:50px;
  height:70px;
  margin:3px;
  border-radius:6px;
  position:relative;
  font-weight:bold;
  box-shadow:0 3px 6px rgba(0,0,0,0.3);
  overflow:hidden;
}
.card-red {
  background:linear-gradient(145deg, #ffffff, #f0f0f0);
  color:#d63031;
  border:2px solid #d63031;
}
.card-black {
  background:linear-gradient(145deg, #ffffff, #f0f0f0);
  color:#2d3436;
  border:2px solid #2d3436;
}
.card-rank {
  position:absolute;
  top:5px;
  left:5px;
  font-size:18px;
  font-weight:bold;
}
.card-suit {
  position:absolute;
  bottom:5px;
  right:5px;
  font-size:20px;
}
.card-center {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  font-size:28px;
}
.status {
  padding:12px;
  background:rgba(44, 62, 80, 0.8);
  border-radius:8px;
  margin-bottom:15px;
  font-weight:bold;
  text-align:center;
  border-left:4px solid #2ecc71;
}
.player-row {
  padding:10px;
  margin:6px 0;
  background:rgba(255,255,255,0.08);
  border-radius:8px;
  transition:all 0.3s;
}
.current-turn {
  background:rgba(46, 204, 113, 0.25);
  border-left:4px solid #2ecc71;
  box-shadow:0 0 10px rgba(46, 204, 113, 0.3);
}
.folded {
  opacity:0.5;
  background:rgba(127, 140, 141, 0.2);
}
.allin-indicator {
  color:#f39c12;
  font-weight:bold;
  animation:pulse 1.5s infinite;
}
@keyframes pulse {
  0% { opacity:1; }
  50% { opacity:0.6; }
  100% { opacity:1; }
}
.actions-box {
  background:rgba(0,0,0,0.25);
  padding:20px;
  border-radius:10px;
  margin:20px 0;
  border:2px solid #2ecc71;
}
.pot-info {
  background:rgba(52, 73, 94, 0.8);
  padding:15px;
  border-radius:8px;
  margin:15px 0;
  display:flex;
  justify-content:space-around;
  text-align:center;
  box-shadow:0 4px 8px rgba(0,0,0,0.2);
}
.pot-amount {
  font-size:24px;
  font-weight:bold;
  color:#f1c40f;
}
.btn-fold { 
  background:linear-gradient(145deg, #e74c3c, #c0392b);
  color:white;
}
.btn-check { 
  background:linear-gradient(145deg, #27ae60, #219653);
  color:white;
}
.btn-call { 
  background:linear-gradient(145deg, #3498db, #2980b9);
  color:white;
}
.btn-bet { 
  background:linear-gradient(145deg, #f39c12, #e67e22);
  color:white;
}
.btn-raise { 
  background:linear-gradient(145deg, #e67e22, #d35400);
  color:white;
}
.btn-allin { 
  background:linear-gradient(145deg, #9b59b6, #8e44ad);
  color:white;
}
.badge {
  display:inline-block;
  padding:3px 8px;
  border-radius:12px;
  font-size:0.8em;
  font-weight:bold;
  margin-left:5px;
}
.badge-dealer { background:#9b59b6; }
.badge-sb { background:#3498db; }
.badge-bb { background:#e74c3c; }
.badge-you { background:#2ecc71; }
.badge-allin { background:#f39c12; }
.badge-fold { background:#7f8c8d; }
.player-name {
  font-weight:bold;
  color:#3498db;
}
.you-name {
  color:#2ecc71;
  font-weight:bold;
}
.chips-amount {
  color:#f1c40f;
  font-weight:bold;
}
.bet-amount {
  color:#e74c3c;
  font-weight:bold;
}
.community-cards-container {
  background:rgba(44, 62, 80, 0.6);
  padding:15px;
  border-radius:10px;
  margin:15px 0;
  text-align:center;
}
.my-cards-container {
  background:rgba(46, 204, 113, 0.15);
  padding:15px;
  border-radius:10px;
  margin:15px 0;
  text-align:center;
  border:2px dashed rgba(46, 204, 113, 0.5);
}
.players-container {
  background:rgba(0,0,0,0.2);
  padding:15px;
  border-radius:10px;
  margin:15px 0;
}
.stage-indicator {
  display:inline-block;
  padding:5px 15px;
  background:#9b59b6;
  border-radius:20px;
  font-weight:bold;
  margin-left:10px;
}
.winners-container {
  background:linear-gradient(135deg, rgba(46, 204, 113, 0.3), rgba(39, 174, 96, 0.3));
  padding:20px;
  border-radius:10px;
  margin:20px 0;
  text-align:center;
  animation:pulse 2s infinite;
  border:2px solid #2ecc71;
}
</style>
</head>

<body>

<div id="status" class="status">üéÆ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ...</div>
<div id="app"></div>

<script>
const tg = window.Telegram?.WebApp;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
let me;
if (tg && tg.initDataUnsafe?.user) {
  const user = tg.initDataUnsafe.user;
  me = {
    id: String(user.id),
    name: user.first_name || 
          (user.username ? '@' + user.username : `–ò–≥—Ä–æ–∫_${String(user.id).slice(-4)}`),
    chips: 1000
  };
} else {
  const randomId = Math.random().toString(36).substr(2, 6).toUpperCase();
  me = {
    id: 'debug_' + randomId,
    name: `–ò–≥—Ä–æ–∫_${randomId}`,
    chips: 1000
  };
}

const socket = io({ transports: ['websocket'] });

let room = null;
let myCards = [];
let gameState = null;

// ============= UTILITY FUNCTIONS =============

function getPlayerDisplayName(player, isMe = false) {
  if (isMe) return `${player.name} üë§`;
  
  // –ï—Å–ª–∏ –∏–º—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å @ - —ç—Ç–æ username
  if (player.name.startsWith('@')) return player.name;
  
  // –ï—Å–ª–∏ –∏–º—è —Å–æ–¥–µ—Ä–∂–∏—Ç '–ò–≥—Ä–æ–∫_' - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π ID
  if (player.name.includes('–ò–≥—Ä–æ–∫_')) {
    const idPart = player.name.split('_')[1] || '';
    return `–ò–≥—Ä–æ–∫_${idPart.substring(0, 4)}`;
  }
  
  // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ –∏–º–µ–Ω–∏
  return player.name.length > 10 ? player.name.substring(0, 10) + '...' : player.name;
}

function renderCard(card) {
  if (!card) return '';
  
  const rank = card.rank;
  const suit = card.suit.toLowerCase();
  const isRed = suit === 'h' || suit === 'd';
  const suitSymbol = {
    's': '‚ô†',
    'h': '‚ô•',
    'd': '‚ô¶',
    'c': '‚ô£'
  }[suit] || suit;
  
  return `
    <div class="card ${isRed ? 'card-red' : 'card-black'}">
      <div class="card-rank">${rank}</div>
      <div class="card-center">${suitSymbol}</div>
      <div class="card-suit">${suitSymbol}</div>
    </div>
  `;
}

function getStageName(stage) {
  const stages = {
    'preflop': '–ü—Ä–µ—Ñ–ª–æ–ø',
    'flop': '–§–ª–æ–ø',
    'turn': '–¢—ë—Ä–Ω',
    'river': '–†–∏–≤–µ—Ä',
    'showdown': '–®–æ—É–¥–∞—É–Ω'
  };
  return stages[stage] || stage;
}

function updateStatus(text) {
  document.getElementById('status').innerText = text;
}

// ============= UI FUNCTIONS =============

function showLobby() {
  document.getElementById('app').innerHTML = `
    <div style="text-align:center; padding:20px;">
      <h1 style="color:#2ecc71; margin-bottom:30px;">üé¥ POKER ROYALE</h1>
      
      <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; margin:0 auto 30px; max-width:400px;">
        <div style="margin-bottom:20px;">
          <h3>üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h3>
          <p><strong>–ò–º—è:</strong> ${me.name}</p>
          <p><strong>ID:</strong> ${me.id.slice(0, 12)}...</p>
          <p><strong>–§–∏—à–∫–∏:</strong> <span style="color:#f1c40f;">${me.chips}</span></p>
        </div>
        
        <div style="margin:30px 0;">
          <button onclick="createRoom()" style="
            background:linear-gradient(145deg, #f39c12, #e67e22); 
            padding:15px 30px; 
            font-size:18px;
            width:100%;
            margin-bottom:10px;">
            üéÆ –°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£
          </button>
        </div>
        
        <div style="border-top:2px solid rgba(255,255,255,0.1); padding-top:20px;">
          <h3>üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h3>
          <input id="code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" 
                 style="padding:12px; width:70%; border-radius:8px; border:2px solid #3498db; font-size:16px;">
          <button onclick="joinRoom()" style="
            background:linear-gradient(145deg, #27ae60, #219653); 
            padding:12px 25px; 
            margin-top:10px;
            font-size:16px;">
            –í–û–ô–¢–ò
          </button>
        </div>
      </div>
    </div>
  `;
  updateStatus('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–æ–∫–µ—Ä!');
}

function showRoom() {
  if (!room) return;
  
  document.getElementById('app').innerHTML = `
    <div style="max-width:600px; margin:0 auto;">
      <h2 style="text-align:center; color:#f1c40f;">üéØ –ö–û–ú–ù–ê–¢–ê: ${room.code}</h2>
      
      <div style="background:rgba(52, 73, 94, 0.8); padding:15px; border-radius:10px; text-align:center; margin:15px 0;">
        <p style="font-size:20px; margin:0;">
          <strong>–ö–æ–¥ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:</strong><br>
          <span style="font-size:28px; color:#2ecc71; letter-spacing:3px;">${room.code}</span>
        </p>
      </div>
      
      <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; margin:20px 0;">
        <h3 style="margin-top:0;">üë• –ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ (${room.players.length})</h3>
        ${room.players.map(p => `
          <div class="player-row" style="${p.id === me.id ? 'background:rgba(46, 204, 113, 0.2);' : ''}">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <span class="${p.id === me.id ? 'you-name' : 'player-name'}">
                  ${getPlayerDisplayName(p, p.id === me.id)}
                </span>
                ${p.id === me.id ? '<span class="badge badge-you">–í–´</span>' : ''}
              </div>
              <div>
                <span class="chips-amount">üí∞ ${p.chips}</span>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      
      <div style="text-align:center; margin-top:30px;">
        ${room.players.length >= 2 ? `
          <button onclick="startGame()" style="
            background:linear-gradient(145deg, #27ae60, #219653); 
            padding:15px 40px; 
            font-size:18px;
            margin-right:15px;">
            üéØ –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
          </button>
        ` : `
          <div style="background:rgba(243, 156, 18, 0.2); padding:15px; border-radius:8px; margin-bottom:20px;">
            <p>‚è≥ –û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</p>
            <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ <strong>${room.code}</strong> –¥—Ä—É–≥—É</p>
          </div>
        `}
        
        <button onclick="leaveRoom()" style="
          background:linear-gradient(145deg, #e74c3c, #c0392b); 
          padding:15px 30px; 
          font-size:16px;">
          üö™ –í–´–ô–¢–ò
        </button>
      </div>
    </div>
  `;
  updateStatus(`–í—ã –≤ –∫–æ–º–Ω–∞—Ç–µ ${room.code} | –ò–≥—Ä–æ–∫–æ–≤: ${room.players.length}`);
}

function showGame() {
  if (!gameState) return;
  
  const isMyTurn = gameState.currentPlayerId === me.id && !gameState.finished;
  const meInGame = gameState.players.find(p => p.id === me.id);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à–∏ —Ñ–∏—à–∫–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
  if (meInGame) {
    me.chips = meInGame.chips;
  }
  
  const stageName = getStageName(gameState.stage);
  const currentPlayerName = gameState.players.find(p => p.id === gameState.currentPlayerId)?.name || '...';
  
  document.getElementById('app').innerHTML = `
    <div style="max-width:800px; margin:0 auto;">
      <h2 style="text-align:center; color:#f1c40f; margin-bottom:5px;">POKER TABLE</h2>
      <p style="text-align:center; color:#bdc3c7; margin-top:0;">–ö–æ–º–Ω–∞—Ç–∞: ${room?.code || ''}</p>
      
      <!-- –°—Ç–∞—Ç—É—Å –∏ –±–∞–Ω–∫ -->
      <div class="pot-info">
        <div>
          <div style="color:#95a5a6;">–°—Ç–∞–¥–∏—è</div>
          <div class="stage-indicator">${stageName}</div>
        </div>
        <div>
          <div style="color:#95a5a6;">–ë–∞–Ω–∫</div>
          <div class="pot-amount">${gameState.pot}</div>
        </div>
        <div>
          <div style="color:#95a5a6;">–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞</div>
          <div style="font-size:20px; color:#e74c3c;">${gameState.currentBet}</div>
        </div>
      </div>
      
      <!-- –ö–∞—Ä—Ç—ã —Å—Ç–æ–ª–∞ -->
      <div class="community-cards-container">
        <h3 style="margin-top:0;">üìä –ö–ê–†–¢–´ –°–¢–û–õ–ê</h3>
        ${gameState.communityCards.length > 0 
          ? gameState.communityCards.map(card => renderCard(card)).join('')
          : '<p style="color:#95a5a6; font-style:italic;">–ö–∞—Ä—Ç—ã –±—É–¥—É—Ç –æ—Ç–∫—Ä—ã—Ç—ã –Ω–∞ —Ñ–ª–æ–ø–µ</p>'
        }
      </div>
      
      <!-- –í–∞—à–∏ –∫–∞—Ä—Ç—ã -->
      <div class="my-cards-container">
        <h3 style="margin-top:0;">üÉè –í–ê–®–ò –ö–ê–†–¢–´</h3>
        ${myCards.length > 0 
          ? myCards.map(card => renderCard(card)).join('')
          : '<p style="color:#95a5a6;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>'
        }
        ${meInGame ? `
          <div style="margin-top:15px;">
            <span style="color:#bdc3c7;">–§–∏—à–∫–∏: </span>
            <span class="chips-amount">${meInGame.chips}</span>
            ${meInGame.bet > 0 ? `
              <span style="margin-left:15px; color:#bdc3c7;">–°—Ç–∞–≤–∫–∞: </span>
              <span class="bet-amount">${meInGame.bet}</span>
            ` : ''}
          </div>
        ` : ''}
      </div>
      
      <!-- –ò–≥—Ä–æ–∫–∏ -->
      <div class="players-container">
        <h3 style="margin-top:0;">üë• –ò–ì–†–û–ö–ò –ó–ê –°–¢–û–õ–û–ú</h3>
        ${gameState.players.map(p => {
          const isCurrent = p.id === gameState.currentPlayerId;
          const playerIndex = gameState.players.indexOf(p);
          const isDealer = playerIndex === gameState.dealerIndex;
          const isSB = playerIndex === gameState.sbIndex;
          const isBB = playerIndex === gameState.bbIndex;
          const isMe = p.id === me.id;
          
          return `
            <div class="player-row ${isCurrent ? 'current-turn' : ''} ${p.folded ? 'folded' : ''}">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <span class="${isMe ? 'you-name' : 'player-name'}">
                    ${getPlayerDisplayName(p, isMe)}
                  </span>
                  ${isDealer ? '<span class="badge badge-dealer">D</span>' : ''}
                  ${isSB ? '<span class="badge badge-sb">SB</span>' : ''}
                  ${isBB ? '<span class="badge badge-bb">BB</span>' : ''}
                  ${p.folded ? '<span class="badge badge-fold">FOLD</span>' : ''}
                  ${p.allIn ? '<span class="badge badge-allin">ALL-IN</span>' : ''}
                  ${isMe ? '<span class="badge badge-you">–í–´</span>' : ''}
                  ${isCurrent ? ' üéØ' : ''}
                </div>
                <div>
                  <span class="chips-amount">${p.chips}</span>
                  ${p.bet > 0 ? `<span class="bet-amount" style="margin-left:10px;">+${p.bet}</span>` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      ${!gameState.finished && isMyTurn ? renderActions() : ''}
      
      ${gameState.finished ? renderWinners() : ''}
      
      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
      <div style="text-align:center; margin-top:30px;">
        <button onclick="leaveRoom()" style="
          background:linear-gradient(145deg, #e74c3c, #c0392b); 
          padding:12px 25px;
          margin-right:10px;">
          üö™ –í—ã–π—Ç–∏
        </button>
        ${gameState.finished ? `
          <button onclick="startNewHand()" style="
            background:linear-gradient(145deg, #27ae60, #219653); 
            padding:12px 25px;">
            üÉè –ù–æ–≤–∞—è —Ä–∞–∑–¥–∞—á–∞
          </button>
        ` : ''}
      </div>
      
      <!-- –î–∏–∞–ª–æ–≥ –¥–ª—è —Å—Ç–∞–≤–æ–∫ -->
      <div id="betDialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); 
           background:#2c3e50; padding:25px; border-radius:15px; z-index:1000; box-shadow:0 10px 30px rgba(0,0,0,0.5); 
           min-width:300px;">
        <h3 id="dialogTitle" style="margin-top:0; color:#f1c40f;">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</h3>
        <div id="dialogInfo" style="margin:15px 0; line-height:1.6;"></div>
        <input type="number" id="amountInput" value="20" 
               style="padding:12px; width:100%; border-radius:8px; border:2px solid #3498db; font-size:16px; box-sizing:border-box;">
        <div style="margin-top:20px; display:flex; gap:10px;">
          <button onclick="submitBet()" style="flex:1; background:#27ae60; padding:12px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
          <button onclick="hideBetDialog()" style="flex:1; background:#7f8c8d; padding:12px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
      <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:999;"></div>
    </div>
  `;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
  if (isMyTurn) {
    updateStatus(`üéØ –í–ê–® –•–û–î! –°—Ç–∞–¥–∏—è: ${stageName}`);
  } else if (gameState.finished) {
    updateStatus(`üéâ –†–ê–ó–î–ê–ß–ê –ó–ê–í–ï–†–®–ï–ù–ê!`);
  } else {
    updateStatus(`‚è≥ –•–æ–¥–∏—Ç: ${getPlayerDisplayName(gameState.players.find(p => p.id === gameState.currentPlayerId) || {name: currentPlayerName})}`);
  }
  
  // –ï—Å–ª–∏ –Ω–∞—à–∞ –æ—á–µ—Ä–µ–¥—å, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è
  if (isMyTurn) {
    setTimeout(updateActions, 100);
  }
}

function renderActions() {
  return `
    <div class="actions-box">
      <h3 style="margin-top:0; color:#f1c40f; text-align:center;">üéØ –í–ê–® –•–û–î</h3>
      <div id="actionsContainer" style="text-align:center;">
        <p>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π...</p>
      </div>
    </div>
  `;
}

function updateActions() {
  if (!gameState) return;
  
  const meInGame = gameState.players.find(p => p.id === me.id);
  if (!meInGame || meInGame.folded || meInGame.allIn) return;
  
  const toCall = gameState.currentBet - meInGame.bet;
  const canCheck = toCall === 0;
  const canCall = toCall > 0 && meInGame.chips >= toCall;
  const canBet = gameState.currentBet === 0 && meInGame.chips > 0;
  const canRaise = meInGame.chips > toCall && toCall < meInGame.chips;
  const isAllIn = meInGame.allIn;
  
  console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:', { toCall, canCheck, canCall, canBet, canRaise, isAllIn });
  
  const actionsContainer = document.getElementById('actionsContainer');
  if (!actionsContainer) return;
  
  let actionsHTML = '';
  
  if (toCall > 0) {
    actionsHTML += `
      <div style="background:rgba(231, 76, 60, 0.2); padding:10px; border-radius:8px; margin-bottom:15px;">
        <p style="margin:0; font-size:16px;">
          –ù—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å: <strong style="color:#e74c3c; font-size:18px;">${toCall}</strong> —á—Ç–æ–±—ã –∫–æ–ª–ª–∏—Ä–æ–≤–∞—Ç—å
        </p>
      </div>
    `;
  }
  
  actionsHTML += `
    <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
      <!-- –§–æ–ª–¥ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω–µ all-in -->
      <button onclick="fold()" class="btn-fold" ${isAllIn ? 'disabled' : ''} style="flex:1; min-width:120px;">
        ‚ùå –§–û–õ–î
      </button>
      
      <!-- –ß–µ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –∫–æ–ª–ª–∏—Ç—å -->
      ${canCheck ? `
        <button onclick="check()" class="btn-check" style="flex:1; min-width:120px;">
          ‚úì –ß–ï–ö
        </button>
      ` : ''}
      
      <!-- –ö–æ–ª–ª –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å -->
      ${canCall ? `
        <button onclick="call()" class="btn-call" style="flex:1; min-width:120px;">
          üìû –ö–û–õ–õ (${toCall})
        </button>
      ` : ''}
      
      <!-- –ë–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –µ—â–µ –Ω–µ —Å—Ç–∞–≤–∏–ª –Ω–∞ —ç—Ç–æ–π —É–ª–∏—Ü–µ -->
      ${canBet ? `
        <button onclick="showBetDialog('bet')" class="btn-bet" style="flex:1; min-width:120px;">
          üí∞ –ë–ï–¢
        </button>
      ` : ''}
      
      <!-- –†–µ–π–∑ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å —Ñ–∏—à–∫–∏ –¥–ª—è —Ä–µ–π–∑–∞ -->
      ${canRaise ? `
        <button onclick="showBetDialog('raise')" class="btn-raise" style="flex:1; min-width:120px;">
          üìà –†–ï–ô–ó
        </button>
      ` : ''}
      
      <!-- All-in –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏—à–∫–∏ -->
      ${!isAllIn && meInGame.chips > 0 ? `
        <button onclick="allIn()" class="btn-allin" style="flex:1; min-width:120px;">
          ‚ö° ALL-IN (${meInGame.chips})
        </button>
      ` : ''}
    </div>
  `;
  
  actionsContainer.innerHTML = actionsHTML;
}

function renderWinners() {
  if (!gameState.winners || gameState.winners.length === 0) return '';
  
  return `
    <div class="winners-container">
      <h2 style="color:#f1c40f; margin-top:0;">üèÜ –ü–û–ë–ï–î–ò–¢–ï–õ–ò üèÜ</h2>
      <p style="font-size:18px;">
        <strong>–õ—É—á—à–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è:</strong> 
        <span style="color:#2ecc71;">${gameState.winningHandName || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}</span>
      </p>
      
      <div style="margin:20px 0;">
        ${gameState.winners.map(winner => {
          const player = gameState.players.find(p => p.id === winner.id);
          return `
            <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; margin:10px 0;">
              <div style="font-size:20px; color:#f1c40f; margin-bottom:5px;">
                ${getPlayerDisplayName(player || winner, player?.id === me.id)}
              </div>
              ${player?.handRank ? `
                <div style="color:#bdc3c7;">
                  –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: <strong>${player.handRank}</strong>
                </div>
              ` : ''}
            </div>
          `;
        }).join('')}
      </div>
      
      <p style="color:#95a5a6; font-style:italic;">
        –ù–∞–∂–º–∏—Ç–µ "–ù–æ–≤–∞—è —Ä–∞–∑–¥–∞—á–∞" –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã
      </p>
    </div>
  `;
}

// ============= GAME ACTIONS =============

function createRoom() {
  socket.emit('create_room', { user: me });
  updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã...');
}

function joinRoom() {
  const code = document.getElementById('code').value.trim().toUpperCase();
  if (!code) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
    return;
  }
  socket.emit('join_room', { code, user: me });
  updateStatus('–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...');
}

function leaveRoom() {
  if (!room) return;
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É?')) {
    socket.emit('leave_room', { code: room.code, playerId: me.id });
    room = null;
    gameState = null;
    myCards = [];
    showLobby();
  }
}

function startGame() {
  if (!room) return;
  socket.emit('start_game', { code: room.code });
  updateStatus('–ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
}

function startNewHand() {
  if (!room) return;
  socket.emit('start_game', { code: room.code });
  updateStatus('–ù–æ–≤–∞—è —Ä–∞–∑–¥–∞—á–∞...');
}

// –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–∞
function fold() {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –∫–∞—Ä—Ç—ã?')) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'fold'
  });
}

function check() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'check'
  });
}

function call() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'call' }
  });
}

function allIn() {
  const meInGame = gameState?.players.find(p => p.id === me.id);
  if (!meInGame) return;
  
  if (!confirm(`–ü–æ–π—Ç–∏ ALL-IN –Ω–∞ ${meInGame.chips} —Ñ–∏—à–µ–∫?`)) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'allin' }
  });
}

// –î–∏–∞–ª–æ–≥ –¥–ª—è —Å—Ç–∞–≤–æ–∫/—Ä–µ–π–∑–æ–≤
let currentDialogType = 'bet';

function showBetDialog(type) {
  currentDialogType = type;
  const meInGame = gameState?.players.find(p => p.id === me.id);
  if (!meInGame) return;
  
  const dialog = document.getElementById('betDialog');
  const overlay = document.getElementById('overlay');
  const input = document.getElementById('amountInput');
  const info = document.getElementById('dialogInfo');
  const title = document.getElementById('dialogTitle');
  
  if (type === 'bet') {
    title.textContent = '–°–î–ï–õ–ê–¢–¨ –°–¢–ê–í–ö–£';
    info.innerHTML = `
      <div style="color:#bdc3c7;">
        <div>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: <strong style="color:#f39c12;">20</strong></div>
        <div>–í–∞—à–∏ —Ñ–∏—à–∫–∏: <strong style="color:#2ecc71;">${meInGame.chips}</strong></div>
      </div>
    `;
    input.min = 20;
    input.max = meInGame.chips;
    input.value = Math.max(20, Math.min(100, meInGame.chips));
  } else {
    title.textContent = '–°–î–ï–õ–ê–¢–¨ –†–ï–ô–ó';
    const minRaise = gameState.currentBet + gameState.minRaise;
    info.innerHTML = `
      <div style="color:#bdc3c7;">
        <div>–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: <strong style="color:#e74c3c;">${gameState.currentBet}</strong></div>
        <div>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π–∑: <strong style="color:#f39c12;">${minRaise}</strong></div>
        <div>–í–∞—à–∏ —Ñ–∏—à–∫–∏: <strong style="color:#2ecc71;">${meInGame.chips}</strong></div>
      </div>
    `;
    input.min = minRaise;
    input.max = meInGame.chips + meInGame.bet;
    input.value = minRaise;
  }
  
  dialog.style.display = 'block';
  overlay.style.display = 'block';
  setTimeout(() => input.focus(), 100);
}

function hideBetDialog() {
  document.getElementById('betDialog').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
}

function submitBet() {
  const amount = parseInt(document.getElementById('amountInput').value);
  if (isNaN(amount) || amount <= 0) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
    return;
  }
  
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: currentDialogType, amount: amount }
  });
  
  hideBetDialog();
}

// ============= SOCKET HANDLERS =============

socket.on('connect', () => {
  console.log('Connected to server');
  updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
});

socket.on('disconnect', () => {
  updateStatus('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
});

socket.on('room_joined', (r) => {
  console.log('Room joined:', r);
  room = r;
  showRoom();
});

socket.on('room_update', (r) => {
  console.log('Room updated:', r);
  room = r;
  if (!gameState) {
    showRoom();
  }
});

socket.on('game_started', ({ publicState }) => {
  console.log('Game started:', publicState);
  gameState = publicState;
  myCards = [];
  
  setTimeout(() => {
    socket.emit('get_my_cards', {
      code: room.code,
      playerId: me.id
    });
  }, 500);
  
  showGame();
});

socket.on('game_update', (state) => {
  console.log('Game updated:', state);
  gameState = state;
  showGame();
});

socket.on('my_cards', (cards) => {
  console.log('Received my cards:', cards);
  myCards = cards;
  if (gameState) {
    showGame();
  }
});

socket.on('error_msg', (msg) => {
  console.error('Server error:', msg);
  alert('‚ùå –û—à–∏–±–∫–∞: ' + msg);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
showLobby();
</script>
</body>
</html>