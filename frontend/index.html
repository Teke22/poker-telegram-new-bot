<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Texas Hold'em Poker</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body {
  background: linear-gradient(135deg, #0b3d2e 0%, #1a5c48 100%);
  color: #f0f0f0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  padding: 20px;
  margin: 0;
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.header {
  text-align: center;
  margin-bottom: 30px;
  padding-bottom: 15px;
  border-bottom: 2px solid #2ecc71;
}

h1 {
  color: #2ecc71;
  margin: 0;
  font-size: 2.5em;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

h2, h3 {
  color: #27ae60;
  margin-top: 20px;
}

.game-board {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.main-game {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 20px;
}

.side-panel {
  background: rgba(0, 0, 0, 0.4);
  border-radius: 10px;
  padding: 20px;
}

.card {
  background: white;
  color: #2c3e50;
  padding: 8px 10px;
  margin: 4px;
  border-radius: 6px;
  display: inline-block;
  font-weight: bold;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  min-width: 40px;
  text-align: center;
}

.card.spades { border-left: 4px solid #2c3e50; }
.card.hearts { border-left: 4px solid #e74c3c; color: #e74c3c; }
.card.diamonds { border-left: 4px solid #e74c3c; color: #e74c3c; }
.card.clubs { border-left: 4px solid #2c3e50; }

.suit-icon {
  font-size: 0.9em;
  margin-left: 2px;
}

.pot-info {
  background: #34495e;
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.pot-amount {
  font-size: 1.8em;
  font-weight: bold;
  color: #f1c40f;
}

.community-cards {
  background: rgba(52, 73, 94, 0.7);
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  text-align: center;
}

.player-list {
  list-style: none;
  padding: 0;
}

.player-item {
  background: rgba(255, 255, 255, 0.1);
  margin: 8px 0;
  padding: 12px;
  border-radius: 8px;
  border-left: 4px solid #3498db;
  transition: all 0.3s;
}

.player-item.current-turn {
  background: rgba(46, 204, 113, 0.2);
  border-left-color: #2ecc71;
  box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
}

.player-item.folded {
  opacity: 0.6;
  border-left-color: #7f8c8d;
}

.player-item.allin {
  border-left-color: #f39c12;
}

.player-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.player-chips {
  color: #f1c40f;
  font-weight: bold;
}

.player-bet {
  color: #e74c3c;
  font-weight: bold;
}

.actions {
  display: flex;
  gap: 10px;
  margin: 20px 0;
  flex-wrap: wrap;
  justify-content: center;
}

button {
  background: #3498db;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1em;
  transition: all 0.3s;
  min-width: 100px;
}

button:hover {
  background: #2980b9;
  transform: translateY(-2px);
}

button:active {
  transform: translateY(0);
}

button:disabled {
  background: #7f8c8d;
  cursor: not-allowed;
  transform: none;
}

button.fold { background: #e74c3c; }
button.fold:hover { background: #c0392b; }

button.call { background: #2ecc71; }
button.call:hover { background: #27ae60; }

button.raise { background: #f39c12; }
button.raise:hover { background: #d35400; }

button.allin { 
  background: linear-gradient(45deg, #f39c12, #e74c3c);
  font-weight: bold;
}

.stage-indicator {
  display: inline-block;
  padding: 5px 15px;
  background: #9b59b6;
  border-radius: 20px;
  font-weight: bold;
  margin-left: 10px;
}

.winner-section {
  background: linear-gradient(135deg, #2ecc71, #27ae60);
  padding: 20px;
  border-radius: 10px;
  margin-top: 20px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
  100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
}

.side-pot {
  background: rgba(243, 156, 18, 0.2);
  padding: 10px;
  margin: 5px 0;
  border-radius: 5px;
  border-left: 3px solid #f39c12;
}

.badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: bold;
  margin-left: 8px;
}

.badge-dealer { background: #9b59b6; }
.badge-sb { background: #3498db; }
.badge-bb { background: #e74c3c; }
.badge-allin { background: #f39c12; }
.badge-folded { background: #7f8c8d; }

.lobby {
  text-align: center;
  padding: 40px;
}

.lobby input {
  padding: 12px;
  margin: 10px;
  border-radius: 6px;
  border: 2px solid #3498db;
  font-size: 1em;
  width: 200px;
}

.lobby button {
  margin: 10px;
}

.status-bar {
  background: rgba(0, 0, 0, 0.5);
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
  display: flex;
  justify-content: space-between;
}

.debug-info {
  background: rgba(0, 0, 0, 0.5);
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
  font-family: monospace;
  font-size: 0.9em;
  max-height: 200px;
  overflow-y: auto;
}

.debug-toggle {
  background: #7f8c8d;
  font-size: 0.8em;
  padding: 5px 10px;
}

.debug-toggle:hover {
  background: #95a5a6;
}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>‚ô†Ô∏è ‚ô•Ô∏è Texas Hold'em Poker ‚ô¶Ô∏è ‚ô£Ô∏è</h1>
    <div id="playerInfo"></div>
  </div>
  
  <div id="app"></div>
  
  <div id="debugPanel" style="display: none; margin-top: 20px;">
    <h3>Debug Information</h3>
    <pre id="debugOutput"></pre>
  </div>
</div>

<script>
const socket = io({ transports: ['websocket'] });

const me = {
  id: 'u_' + Math.random().toString(36).slice(2, 11),
  name: 'Player_' + Math.floor(Math.random() * 1000),
  chips: 1000
};

let room = null;
let myCards = [];
let myPrivateState = null;
let lastState = null;
let showDebug = false;

/* ---------- UI RENDERERS ---------- */

function renderLobby() {
  document.getElementById('app').innerHTML = `
    <div class="lobby">
      <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–æ–∫–µ—Ä!</h2>
      <p>–í–∞—à ID: <strong>${me.id}</strong></p>
      <p>–§–∏—à–∫–∏: <strong>${me.chips}</strong></p>
      <div style="margin: 30px 0;">
        <button onclick="createRoom()" style="padding: 15px 30px; font-size: 1.2em;">
          üéÆ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
        </button>
      </div>
      <div>
        <input id="code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" />
        <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
      </div>
    </div>
  `;
  document.getElementById('playerInfo').innerHTML = '';
}

function renderRoom() {
  if (!room) return;
  
  document.getElementById('app').innerHTML = `
    <div class="game-board">
      <div class="main-game">
        <h2>–ö–æ–º–Ω–∞—Ç–∞: <span style="color:#f1c40f">${room.code}</span></h2>
        
        <div class="status-bar">
          <span>–ò–≥—Ä–æ–∫–æ–≤: <strong>${room.players.length}</strong></span>
          <span>ID –∫–æ–º–Ω–∞—Ç—ã: <strong>${room.id}</strong></span>
        </div>
        
        <h3>üë• –ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ</h3>
        <ul class="player-list">
          ${room.players.map((p, idx) => `
            <li class="player-item">
              <div class="player-info">
                <span>
                  ${p.name} 
                  ${idx === 0 ? '<span class="badge badge-dealer">D</span>' : ''}
                  <span class="badge" style="background:#${p.id === me.id ? '2ecc71' : '3498db'}">
                    ${p.id === me.id ? '–í—ã' : '–ò–≥—Ä–æ–∫'}
                  </span>
                </span>
                <span class="player-chips">${p.chips} —Ñ–∏—à–µ–∫</span>
              </div>
            </li>
          `).join('')}
        </ul>
        
        <div class="actions">
          <button onclick="startGame()" ${room.players.length < 2 ? 'disabled' : ''}>
            üéØ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
          </button>
          <button onclick="leaveRoom()" style="background:#e74c3c">
            üö™ –í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
          </button>
        </div>
      </div>
      
      <div class="side-panel">
        <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <p>–ë–ª–∞–π–Ω–¥—ã: ${room.smallBlind || 10}/${room.bigBlind || 20}</p>
        <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫: ${room.minBuyin || 100}</p>
        <p>–ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤: ${room.maxPlayers || 9}</p>
        
        <h3>üìã –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</h3>
        <div style="background:#2c3e50; padding:15px; border-radius:8px; text-align:center;">
          <h2 style="margin:0; color:#f1c40f">${room.code}</h2>
          <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏</p>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('playerInfo').innerHTML = `
    <p>–í—ã: <strong>${me.name}</strong> | ID: ${me.id} | –§–∏—à–∫–∏: ${me.chips}</p>
  `;
}

function renderGame(state) {
  lastState = state;
  
  const isMyTurn = state.currentPlayerId === me.id && !state.finished;
  const stageNames = {
    'preflop': '–ü—Ä–µ—Ñ–ª–æ–ø',
    'flop': '–§–ª–æ–ø',
    'turn': '–¢—ë—Ä–Ω',
    'river': '–†–∏–≤–µ—Ä',
    'showdown': '–®–æ—É–¥–∞—É–Ω'
  };
  
  document.getElementById('app').innerHTML = `
    <div class="game-board">
      <div class="main-game">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —Ä–∞—É–Ω–¥–µ -->
        <div class="status-bar">
          <span>–°—Ç–∞–¥–∏—è: <strong class="stage-indicator">${stageNames[state.stage] || state.stage}</strong></span>
          <span>–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: <strong style="color:#e74c3c">${state.currentBet}</strong></span>
          <span>–ú–∏–Ω. —Ä–µ–π–∑: <strong style="color:#f39c12">${state.minRaise || state.lastRaise || 20}</strong></span>
        </div>
        
        <!-- –ö–∞—Ä—Ç—ã —Å—Ç–æ–ª–∞ -->
        <div class="community-cards">
          <h3>–ö–∞—Ä—Ç—ã –Ω–∞ —Å—Ç–æ–ª–µ</h3>
          ${state.communityCards.length > 0 
            ? state.communityCards.map(c => renderCard(c)).join('')
            : '<p>–ö–∞—Ä—Ç—ã –µ—â–µ –Ω–µ –≤—ã–ª–æ–∂–µ–Ω—ã</p>'
          }
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–Ω–∫–∞—Ö -->
        <div class="pot-info">
          <div>
            <div>–û—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫</div>
            <div class="pot-amount">${state.pot}</div>
          </div>
          ${state.sidePots && state.sidePots.length > 0 ? `
            <div>
              <div>Side Pots</div>
              ${state.sidePots.map((pot, i) => `
                <div class="side-pot">
                  <small>Side Pot ${i+1}:</small>
                  <div><strong>${pot.amount}</strong></div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
        
        <!-- –í–∞—à–∏ –∫–∞—Ä—Ç—ã -->
        <div style="background:rgba(46,204,113,0.1); padding:15px; border-radius:8px; margin:15px 0;">
          <h3>–í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
          ${myCards.length > 0 
            ? myCards.map(c => renderCard(c)).join('')
            : '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>'
          }
          ${myPrivateState ? `
            <div style="margin-top:10px; font-size:0.9em;">
              <span>–ù—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å: <strong>${myPrivateState.toCall}</strong></span> |
              <span>–ú–∏–Ω. —Ä–µ–π–∑: <strong>${myPrivateState.minRaiseAmount}</strong></span>
            </div>
          ` : ''}
        </div>
        
        <!-- –ò–≥—Ä–æ–∫–∏ -->
        <h3>–ò–≥—Ä–æ–∫–∏ –∑–∞ —Å—Ç–æ–ª–æ–º</h3>
        <ul class="player-list">
          ${state.players.map((p, idx) => {
            const isCurrent = p.id === state.currentPlayerId;
            const isDealer = idx === state.dealerIndex;
            const isSB = idx === state.sbIndex;
            const isBB = idx === state.bbIndex;
            
            return `
              <li class="player-item ${isCurrent ? 'current-turn' : ''} ${p.folded ? 'folded' : ''}">
                <div class="player-info">
                  <div>
                    <strong>${p.name}</strong>
                    ${isDealer ? '<span class="badge badge-dealer">D</span>' : ''}
                    ${isSB ? '<span class="badge badge-sb">SB</span>' : ''}
                    ${isBB ? '<span class="badge badge-bb">BB</span>' : ''}
                    ${p.allIn ? '<span class="badge badge-allin">ALL-IN</span>' : ''}
                    ${p.folded ? '<span class="badge badge-folded">FOLD</span>' : ''}
                    ${p.id === me.id ? '<span class="badge" style="background:#2ecc71">–í—ã</span>' : ''}
                    ${isCurrent ? '<span style="color:#2ecc71"> ‚Æï –•–û–î–ò–¢</span>' : ''}
                  </div>
                  <div>
                    <span class="player-chips">${p.chips}</span>
                    ${p.bet > 0 ? `<span class="player-bet">+${p.bet}</span>` : ''}
                  </div>
                </div>
                
                ${(state.finished || p.folded) && p.showHand && p.showHand.length > 0 ? `
                  <div style="margin-top:8px;">
                    –ö–∞—Ä—Ç—ã: ${p.showHand.map(c => renderCard(c)).join('')}
                    ${p.handRank ? `<small style="color:#95a5a6"> (${p.handRank})</small>` : ''}
                  </div>
                ` : ''}
                
                ${p.contributedToPot > 0 ? `
                  <div style="font-size:0.8em; color:#95a5a6; margin-top:5px;">
                    –í–ª–æ–∂–∏–ª –≤ –±–∞–Ω–∫: ${p.contributedToPot}
                  </div>
                ` : ''}
              </li>
            `;
          }).join('')}
        </ul>
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        ${!state.finished && isMyTurn ? renderActionButtons() : ''}
        
        ${state.finished ? renderWinners(state) : ''}
      </div>
      
      <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
      <div class="side-panel">
        <h3>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π</h3>
        <div class="actions">
          <button onclick="showDebugInfo()" class="debug-toggle">
            ${showDebug ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å'} Debug
          </button>
          ${state.finished ? `
            <button onclick="newHand()" style="background:#9b59b6">
              –ù–æ–≤–∞—è —Ä–∞–∑–¥–∞—á–∞
            </button>
          ` : ''}
        </div>
        
        <h3>üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã</h3>
        <p>–°—Ç–∞–¥–∏—è: <strong>${state.stage}</strong></p>
        <p>–¢–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫: <strong>${state.players.find(p => p.id === state.currentPlayerId)?.name || '–ù–µ—Ç'}</strong></p>
        <p>–î–∏–ª–µ—Ä–∞: <strong>${state.players[state.dealerIndex]?.name || '–ù–µ—Ç'}</strong></p>
        <p>SB: <strong>${state.players[state.sbIndex]?.name || '–ù–µ—Ç'}</strong></p>
        <p>BB: <strong>${state.players[state.bbIndex]?.name || '–ù–µ—Ç'}</strong></p>
        
        <h3>üí∞ –ë–∞–Ω–∫–∏</h3>
        <p>–û—Å–Ω–æ–≤–Ω–æ–π –±–∞–Ω–∫: <strong>${state.pot}</strong></p>
        <p>Side pots: <strong>${state.sidePots?.length || 0}</strong></p>
        ${state.sidePots && state.sidePots.length > 0 ? `
          <div style="font-size:0.9em;">
            ${state.sidePots.map((pot, i) => `
              <div>Side ${i+1}: ${pot.amount}</div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ –æ–± –∏–≥—Ä–æ–∫–µ
  document.getElementById('playerInfo').innerHTML = `
    <div style="display:flex; justify-content:space-between;">
      <div>
        –í—ã: <strong>${me.name}</strong> | 
        –§–∏—à–∫–∏: <strong style="color:#f1c40f">${me.chips}</strong> |
        ${myPrivateState ? `–ü–æ—Å—Ç–∞–≤–∏—Ç—å: ${myPrivateState.toCall}` : ''}
      </div>
      <div>
        ${room ? `–ö–æ–º–Ω–∞—Ç–∞: ${room.code}` : ''}
      </div>
    </div>
  `;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
  if (showDebug) {
    document.getElementById('debugPanel').style.display = 'block';
    document.getElementById('debugOutput').textContent = JSON.stringify(state, null, 2);
  }
}

function renderCard(card) {
  if (!card) return '';
  const suit = card.suit.toLowerCase();
  const suitSymbols = {
    's': '‚ô†',
    'h': '‚ô•', 
    'd': '‚ô¶',
    'c': '‚ô£'
  };
  const suitClasses = {
    's': 'spades',
    'h': 'hearts',
    'd': 'diamonds',
    'c': 'clubs'
  };
  
  return `
    <span class="card ${suitClasses[suit] || ''}">
      ${card.rank}${suitSymbols[suit] || suit}
    </span>
  `;
}

function renderActionButtons() {
  if (!myPrivateState) return '';
  
  const canCheck = myPrivateState.canCheck && myPrivateState.toCall === 0;
  const canCall = myPrivateState.canCall && myPrivateState.toCall > 0;
  const canBet = myPrivateState.canBet && myPrivateState.toCall === 0;
  const canRaise = myPrivateState.canRaise;
  
  return `
    <div class="actions">
      <button onclick="fold()" class="fold" ${myPrivateState.isAllIn ? 'disabled' : ''}>
        –§–æ–ª–¥
      </button>
      
      ${canCheck ? `
        <button onclick="check()" class="call">
          –ß–µ–∫
        </button>
      ` : ''}
      
      ${canCall ? `
        <button onclick="call()" class="call">
          –ö–æ–ª–ª (${myPrivateState.toCall})
        </button>
      ` : ''}
      
      ${canBet ? `
        <button onclick="promptBet()" class="raise">
          –ë–µ—Ç
        </button>
      ` : ''}
      
      ${canRaise ? `
        <button onclick="promptRaise()" class="raise">
          –†–µ–π–∑
        </button>
      ` : ''}
      
      <button onclick="allIn()" class="allin" ${myPrivateState.isAllIn ? 'disabled' : ''}>
        ALL-IN (${me.chips})
      </button>
    </div>
  `;
}

function renderWinners(state) {
  if (!state.finished || !state.winners?.length) return '';
  
  return `
    <div class="winner-section">
      <h2>üèÜ –ü–û–ë–ï–î–ò–¢–ï–õ–¨${state.winners.length > 1 ? '–ò' : ''} üèÜ</h2>
      <p><strong>–õ—É—á—à–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è:</strong> ${state.winningHandName || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}</p>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
        ${state.winners.map(winner => {
          const player = state.players.find(p => p.id === winner.id);
          return `
            <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:8px;">
              <h3 style="margin-top:0;">${player?.name || winner.name}</h3>
              ${player?.handRank ? `<p>–ö–æ–º–±–∏–Ω–∞—Ü–∏—è: <strong>${player.handRank}</strong></p>` : ''}
              <p>–í—ã–∏–≥—Ä—ã—à: <strong style="color:#f1c40f">???</strong></p>
            </div>
          `;
        }).join('')}
      </div>
      
      <p style="font-size:0.9em; opacity:0.8;">–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Ä–∞–∑–¥–∞—á—É...</p>
    </div>
  `;
}

/* ---------- ACTIONS ---------- */

function createRoom() {
  socket.emit('create_room', { user: me });
}

function joinRoom() {
  const code = document.getElementById('code').value.trim();
  if (!code) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
    return;
  }
  socket.emit('join_room', { code, user: me });
}

function leaveRoom() {
  if (!room) return;
  socket.emit('leave_room', { code: room.code, playerId: me.id });
  room = null;
  myCards = [];
  myPrivateState = null;
  renderLobby();
}

function startGame() {
  if (!room) return;
  socket.emit('start_game', { code: room.code });
}

function newHand() {
  if (!room) return;
  socket.emit('new_hand', { code: room.code });
}

function check() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'check'
  });
}

function call() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'call' }
  });
}

function fold() {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –∫–∞—Ä—Ç—ã?')) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'fold'
  });
}

function allIn() {
  if (!confirm(`–ü–æ–π—Ç–∏ ALL-IN –Ω–∞ ${me.chips} —Ñ–∏—à–µ–∫?`)) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'allin' }
  });
}

function promptBet() {
  if (!myPrivateState) return;
  const amount = prompt(`–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏ (–º–∏–Ω. ${myPrivateState.minBetAmount}):`, myPrivateState.minBetAmount);
  if (amount && !isNaN(amount)) {
    socket.emit('player_action', {
      code: room.code,
      playerId: me.id,
      action: { type: 'bet', amount: parseInt(amount) }
    });
  }
}

function promptRaise() {
  if (!myPrivateState) return;
  const minRaise = myPrivateState.minRaiseAmount;
  const maxRaise = myPrivateState.maxRaiseAmount;
  const amount = prompt(`–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–µ–π–∑–∞ (–º–∏–Ω. ${minRaise}, –º–∞–∫—Å. ${maxRaise}):`, minRaise);
  if (amount && !isNaN(amount)) {
    socket.emit('player_action', {
      code: room.code,
      playerId: me.id,
      action: { type: 'raise', amount: parseInt(amount) }
    });
  }
}

function showDebugInfo() {
  showDebug = !showDebug;
  if (lastState) renderGame(lastState);
}

/* ---------- SOCKET EVENTS ---------- */

socket.on('room_joined', r => {
  room = r;
  me.chips = r.players.find(p => p.id === me.id)?.chips || me.chips;
  renderRoom();
});

socket.on('room_update', r => {
  room = r;
  me.chips = r.players.find(p => p.id === me.id)?.chips || me.chips;
  if (!lastState) renderRoom();
});

socket.on('game_started', ({ publicState }) => {
  myCards = [];
  myPrivateState = null;
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–≤–æ–∏ –∫–∞—Ä—Ç—ã
  setTimeout(() => {
    socket.emit('get_my_cards', {
      code: room.code,
      playerId: me.id
    });
  }, 500);
  
  renderGame(publicState);
});

socket.on('game_update', state => {
  renderGame(state);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–∏ —Ñ–∏—à–∫–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const myPlayer = state.players.find(p => p.id === me.id);
  if (myPlayer) {
    me.chips = myPlayer.chips;
  }
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  socket.emit('get_my_private_state', {
    code: room.code,
    playerId: me.id
  });
});

socket.on('my_cards', cards => {
  myCards = cards;
  if (lastState) renderGame(lastState);
});

socket.on('my_private_state', privateState => {
  myPrivateState = privateState;
  if (lastState) renderGame(lastState);
});

socket.on('error_msg', msg => {
  alert('–û—à–∏–±–∫–∞: ' + msg);
});

socket.on('player_left', data => {
  alert(`–ò–≥—Ä–æ–∫ ${data.playerName} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
renderLobby();
</script>
</body>
</html>