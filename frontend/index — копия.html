<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Poker</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  padding:10px;
  margin:0;
}
button {
  padding:12px 16px;
  margin:5px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  min-width:100px;
  font-size:14px;
}
button:hover {
  opacity:0.9;
}
button:disabled {
  background:#666 !important;
  cursor:not-allowed;
  opacity:0.5;
}
.card {
  background:#fff;
  color:#000;
  padding:8px 10px;
  margin:3px;
  border-radius:5px;
  display:inline-block;
  font-weight:bold;
}
.status {
  padding:10px;
  background:#2c3e50;
  border-radius:5px;
  margin-bottom:10px;
  font-weight:bold;
}
.player-row {
  padding:8px;
  margin:4px 0;
  background:rgba(255,255,255,0.1);
  border-radius:5px;
}
.current-turn {
  background:rgba(46, 204, 113, 0.2);
  border-left:4px solid #2ecc71;
}
.folded {
  opacity:0.5;
}
.allin {
  color:#f39c12;
}
.actions-box {
  background:rgba(0,0,0,0.2);
  padding:15px;
  border-radius:8px;
  margin:15px 0;
  border:1px solid #2ecc71;
}
.pot-info {
  background:#34495e;
  padding:10px;
  border-radius:5px;
  margin:10px 0;
  display:flex;
  justify-content:space-around;
}
.btn-fold { background:#e74c3c; color:white; }
.btn-check { background:#27ae60; color:white; }
.btn-call { background:#3498db; color:white; }
.btn-bet { background:#f39c12; color:white; }
.btn-raise { background:#e67e22; color:white; }
.btn-allin { background:#9b59b6; color:white; }
</style>
</head>

<body>

<div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<div id="app"></div>

<script>
const tg = window.Telegram?.WebApp;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
let me;
if (tg && tg.initDataUnsafe?.user) {
  me = {
    id: String(tg.initDataUnsafe.user.id),
    name: tg.initDataUnsafe.user.first_name || 'Player',
    chips: 1000
  };
} else {
  me = {
    id: 'debug_' + Math.random().toString(36).substr(2, 9),
    name: 'DebugPlayer',
    chips: 1000
  };
}

const socket = io({ transports: ['websocket'] });

let room = null;
let myCards = [];
let gameState = null;

// ============= UI FUNCTIONS =============

function showLobby() {
  document.getElementById('app').innerHTML = `
    <div style="text-align:center;">
      <h2>üé¥ Poker</h2>
      <p>–í–∞—à ID: ${me.id}</p>
      
      <div style="margin:20px 0;">
        <button onclick="createRoom()" style="background:#f39c12; padding:15px 25px; font-size:16px;">
          üéÆ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
        </button>
      </div>
      
      <div style="margin:20px 0;">
        <h3>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è:</h3>
        <input id="code" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" style="padding:10px; width:150px;">
        <button onclick="joinRoom()" style="background:#27ae60; padding:10px 20px;">
          –í–æ–π—Ç–∏
        </button>
      </div>
    </div>
  `;
  updateStatus('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–æ–∫–µ—Ä!');
}

function showRoom() {
  if (!room) return;
  
  document.getElementById('app').innerHTML = `
    <h2>üéØ –ö–æ–º–Ω–∞—Ç–∞: ${room.code}</h2>
    <p>–ö–æ–¥ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: <strong>${room.code}</strong></p>
    
    <h3>üë• –ò–≥—Ä–æ–∫–∏ (${room.players.length})</h3>
    ${room.players.map(p => `
      <div class="player-row">
        ${p.name} - üí∞ ${p.chips} —Ñ–∏—à–µ–∫
        ${p.id === me.id ? ' (–í—ã)' : ''}
      </div>
    `).join('')}
    
    <div style="margin-top:20px;">
      ${room.players.length >= 2 ? `
        <button onclick="startGame()" style="background:#27ae60; padding:12px 24px;">
          üéØ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
        </button>
      ` : `
        <p>‚è≥ –û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</p>
      `}
      
      <button onclick="leaveRoom()" style="background:#e74c3c;">
        üö™ –í—ã–π—Ç–∏
      </button>
    </div>
  `;
  updateStatus(`–í—ã –≤ –∫–æ–º–Ω–∞—Ç–µ ${room.code}`);
}

function showGame() {
  if (!gameState) return;
  
  const isMyTurn = gameState.currentPlayerId === me.id && !gameState.finished;
  const meInGame = gameState.players.find(p => p.id === me.id);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à–∏ —Ñ–∏—à–∫–∏ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
  if (meInGame) {
    me.chips = meInGame.chips;
  }
  
  document.getElementById('app').innerHTML = `
    <h2>üéÆ –ò–≥—Ä–∞</h2>
    
    <div class="pot-info">
      <div>
        <div><strong>–°—Ç–∞–¥–∏—è:</strong> ${getStageName(gameState.stage)}</div>
        <div><strong>–ë–∞–Ω–∫:</strong> ${gameState.pot}</div>
      </div>
      <div>
        <div><strong>–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞:</strong> ${gameState.currentBet}</div>
        <div><strong>–•–æ–¥–∏—Ç:</strong> ${gameState.players.find(p => p.id === gameState.currentPlayerId)?.name || '?'}</div>
      </div>
    </div>
    
    <div>
      <h3>üìä –ö–∞—Ä—Ç—ã —Å—Ç–æ–ª–∞</h3>
      ${gameState.communityCards.length > 0 
        ? gameState.communityCards.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('')
        : '<p>–ö–∞—Ä—Ç—ã –µ—â–µ –Ω–µ –≤—ã–ª–æ–∂–µ–Ω—ã</p>'
      }
    </div>
    
    <div>
      <h3>üÉè –í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
      ${myCards.length > 0 
        ? myCards.map(c => `<span class="card">${c.rank}${c.suit}</span>`).join('')
        : '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç...</p>'
      }
    </div>
    
    <div>
      <h3>üë• –ò–≥—Ä–æ–∫–∏ –∑–∞ —Å—Ç–æ–ª–æ–º</h3>
      ${gameState.players.map(p => {
        const isCurrent = p.id === gameState.currentPlayerId;
        const isDealer = gameState.players.indexOf(p) === gameState.dealerIndex;
        const isSB = gameState.players.indexOf(p) === gameState.sbIndex;
        const isBB = gameState.players.indexOf(p) === gameState.bbIndex;
        
        return `
          <div class="player-row ${isCurrent ? 'current-turn' : ''} ${p.folded ? 'folded' : ''}">
            <div style="display:flex; justify-content:space-between;">
              <div>
                ${p.id === me.id ? 'üë§ ' : ''}
                ${p.name}
                ${isDealer ? ' üÉè' : ''}
                ${isSB ? ' SB' : ''}
                ${isBB ? ' BB' : ''}
                ${p.folded ? ' ‚ùå' : ''}
                ${p.allIn ? ' ‚ö°' : ''}
                ${isCurrent ? ' üéØ' : ''}
              </div>
              <div>
                üí∞ ${p.chips}
                ${p.bet > 0 ? `<span style="color:#f39c12;"> (+${p.bet})</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
    
    <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
    ${!gameState.finished && isMyTurn ? renderActions() : ''}
    
    ${gameState.finished ? renderWinners() : ''}
    
    <div style="margin-top:20px;">
      <button onclick="leaveRoom()" style="background:#e74c3c;">
        üö™ –í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
      </button>
      ${gameState.finished ? `
        <button onclick="startNewHand()" style="background:#27ae60; margin-left:10px;">
          üÉè –ù–æ–≤–∞—è —Ä–∞–∑–¥–∞—á–∞
        </button>
      ` : ''}
    </div>
    
    <!-- –î–∏–∞–ª–æ–≥ –¥–ª—è —Å—Ç–∞–≤–æ–∫ -->
    <div id="betDialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); 
         background:#2c3e50; padding:20px; border-radius:10px; z-index:1000; box-shadow:0 0 20px rgba(0,0,0,0.5);">
      <h3 id="dialogTitle">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</h3>
      <p id="dialogInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
      <input type="number" id="amountInput" value="20" style="padding:10px; width:150px; font-size:16px;">
      <div style="margin-top:15px;">
        <button onclick="submitBet()" style="background:#27ae60; padding:10px 20px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button onclick="hideBetDialog()" style="background:#7f8c8d; padding:10px 20px; margin-left:10px;">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>
  `;
  
  if (isMyTurn) {
    updateStatus(`üéØ –í–∞—à —Ö–æ–¥! –°—Ç–∞–¥–∏—è: ${getStageName(gameState.stage)}`);
  } else if (gameState.finished) {
    updateStatus(`üéâ –†–∞–∑–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!`);
  } else {
    updateStatus(`‚è≥ –•–æ–¥–∏—Ç: ${gameState.players.find(p => p.id === gameState.currentPlayerId)?.name || '...'}`);
  }
  
  // –ï—Å–ª–∏ –Ω–∞—à–∞ –æ—á–µ—Ä–µ–¥—å, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è
  if (isMyTurn) {
    updateActions();
  }
}

function renderActions() {
  // –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
  return `
    <div class="actions-box">
      <h3>üéØ –í–∞—à —Ö–æ–¥</h3>
      <div id="actionsContainer">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π...</p>
      </div>
    </div>
  `;
}

function updateActions() {
  if (!gameState) return;
  
  const meInGame = gameState.players.find(p => p.id === me.id);
  if (!meInGame) return;
  
  const toCall = gameState.currentBet - meInGame.bet;
  const canCheck = toCall === 0;
  const canCall = toCall > 0 && meInGame.chips >= toCall;
  const canBet = gameState.currentBet === 0 && meInGame.chips > 0;
  const canRaise = meInGame.chips > toCall && toCall < meInGame.chips;
  const isAllIn = meInGame.allIn;
  
  console.log('Action calculation:', {
    toCall,
    canCheck,
    canCall,
    canBet,
    canRaise,
    isAllIn,
    currentBet: gameState.currentBet,
    myBet: meInGame.bet,
    myChips: meInGame.chips
  });
  
  const actionsContainer = document.getElementById('actionsContainer');
  if (!actionsContainer) return;
  
  let actionsHTML = '';
  
  if (toCall > 0) {
    actionsHTML += `<p>–ù—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å: <strong>${toCall}</strong> —á—Ç–æ–±—ã –∫–æ–ª–ª–∏—Ä–æ–≤–∞—Ç—å</p>`;
  }
  
  actionsHTML += `
    <div style="display:flex; flex-wrap:wrap; gap:8px;">
      <!-- –§–æ–ª–¥ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω–µ all-in -->
      <button onclick="fold()" class="btn-fold" ${isAllIn ? 'disabled' : ''}>
        ‚ùå –§–æ–ª–¥
      </button>
      
      <!-- –ß–µ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –∫–æ–ª–ª–∏—Ç—å -->
      ${canCheck ? `
        <button onclick="check()" class="btn-check">
          ‚úì –ß–µ–∫
        </button>
      ` : ''}
      
      <!-- –ö–æ–ª–ª –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å -->
      ${canCall ? `
        <button onclick="call()" class="btn-call">
          üìû –ö–æ–ª–ª (${toCall})
        </button>
      ` : ''}
      
      <!-- –ë–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –µ—â–µ –Ω–µ —Å—Ç–∞–≤–∏–ª –Ω–∞ —ç—Ç–æ–π —É–ª–∏—Ü–µ -->
      ${canBet ? `
        <button onclick="showBetDialog('bet')" class="btn-bet">
          üí∞ –ë–µ—Ç
        </button>
      ` : ''}
      
      <!-- –†–µ–π–∑ –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ –µ—Å—Ç—å —Ñ–∏—à–∫–∏ –¥–ª—è —Ä–µ–π–∑–∞ -->
      ${canRaise ? `
        <button onclick="showBetDialog('raise')" class="btn-raise">
          üìà –†–µ–π–∑
        </button>
      ` : ''}
      
      <!-- All-in –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏—à–∫–∏ -->
      ${!isAllIn && meInGame.chips > 0 ? `
        <button onclick="allIn()" class="btn-allin">
          ‚ö° ALL-IN (${meInGame.chips})
        </button>
      ` : ''}
    </div>
  `;
  
  actionsContainer.innerHTML = actionsHTML;
}

function renderWinners() {
  if (!gameState.winners || gameState.winners.length === 0) return '';
  
  return `
    <div class="actions-box" style="background:rgba(46, 204, 113, 0.2);">
      <h2>üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–∏</h2>
      <p><strong>–õ—É—á—à–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è:</strong> ${gameState.winningHandName || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}</p>
      
      <div style="margin:15px 0;">
        ${gameState.winners.map(winner => {
          const player = gameState.players.find(p => p.id === winner.id);
          return `
            <div class="player-row" style="background:rgba(46, 204, 113, 0.3);">
              <strong>${player?.name || winner.name}</strong>
              ${player?.handRank ? `<br>–ö–æ–º–±–∏–Ω–∞—Ü–∏—è: ${player.handRank}` : ''}
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

function getStageName(stage) {
  const stages = {
    'preflop': '–ü—Ä–µ—Ñ–ª–æ–ø',
    'flop': '–§–ª–æ–ø',
    'turn': '–¢—ë—Ä–Ω',
    'river': '–†–∏–≤–µ—Ä',
    'showdown': '–®–æ—É–¥–∞—É–Ω'
  };
  return stages[stage] || stage;
}

function updateStatus(text) {
  document.getElementById('status').innerText = text;
}

// ============= GAME ACTIONS =============

function createRoom() {
  socket.emit('create_room', { user: me });
}

function joinRoom() {
  const code = document.getElementById('code').value.trim().toUpperCase();
  if (!code) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
    return;
  }
  socket.emit('join_room', { code, user: me });
}

function leaveRoom() {
  if (!room) return;
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É?')) {
    socket.emit('leave_room', { code: room.code, playerId: me.id });
    room = null;
    gameState = null;
    myCards = [];
    showLobby();
  }
}

function startGame() {
  if (!room) return;
  socket.emit('start_game', { code: room.code });
}

function startNewHand() {
  if (!room) return;
  socket.emit('start_game', { code: room.code });
}

// –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–∞
function fold() {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫–∞—Ä—Ç—ã?')) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'fold'
  });
}

function check() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'check'
  });
}

function call() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'call' }
  });
}

function allIn() {
  const meInGame = gameState?.players.find(p => p.id === me.id);
  if (!meInGame) return;
  
  if (!confirm(`–ü–æ–π—Ç–∏ ALL-IN –Ω–∞ ${meInGame.chips} —Ñ–∏—à–µ–∫?`)) return;
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'allin' }
  });
}

// –î–∏–∞–ª–æ–≥ –¥–ª—è —Å—Ç–∞–≤–æ–∫/—Ä–µ–π–∑–æ–≤
let currentDialogType = 'bet';

function showBetDialog(type) {
  currentDialogType = type;
  const meInGame = gameState?.players.find(p => p.id === me.id);
  if (!meInGame) return;
  
  const dialog = document.getElementById('betDialog');
  const overlay = document.getElementById('overlay');
  const input = document.getElementById('amountInput');
  const info = document.getElementById('dialogInfo');
  const title = document.getElementById('dialogTitle');
  
  if (type === 'bet') {
    title.textContent = '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É';
    info.innerHTML = `
      –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: <strong>20</strong><br>
      –í–∞—à–∏ —Ñ–∏—à–∫–∏: <strong>${meInGame.chips}</strong>
    `;
    input.min = 20;
    input.max = meInGame.chips;
    input.value = Math.max(20, Math.min(100, meInGame.chips));
  } else {
    title.textContent = '–°–¥–µ–ª–∞—Ç—å —Ä–µ–π–∑';
    const minRaise = gameState.currentBet + gameState.minRaise;
    info.innerHTML = `
      –¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: <strong>${gameState.currentBet}</strong><br>
      –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π–∑: <strong>${minRaise}</strong><br>
      –í–∞—à–∏ —Ñ–∏—à–∫–∏: <strong>${meInGame.chips}</strong>
    `;
    input.min = minRaise;
    input.max = meInGame.chips + meInGame.bet;
    input.value = minRaise;
  }
  
  dialog.style.display = 'block';
  overlay.style.display = 'block';
}

function hideBetDialog() {
  document.getElementById('betDialog').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
}

function submitBet() {
  const amount = parseInt(document.getElementById('amountInput').value);
  if (isNaN(amount) || amount <= 0) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
    return;
  }
  
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: currentDialogType, amount: amount }
  });
  
  hideBetDialog();
}

// ============= SOCKET HANDLERS =============

socket.on('connect', () => {
  console.log('Connected to server');
  updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
});

socket.on('disconnect', () => {
  updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
});

socket.on('room_joined', (r) => {
  console.log('Room joined:', r);
  room = r;
  showRoom();
});

socket.on('room_update', (r) => {
  console.log('Room updated:', r);
  room = r;
  if (!gameState) {
    showRoom();
  }
});

socket.on('game_started', ({ publicState }) => {
  console.log('Game started:', publicState);
  gameState = publicState;
  myCards = [];
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–≤–æ–∏ –∫–∞—Ä—Ç—ã
  setTimeout(() => {
    socket.emit('get_my_cards', {
      code: room.code,
      playerId: me.id
    });
  }, 500);
  
  showGame();
});

socket.on('game_update', (state) => {
  console.log('Game updated:', state);
  gameState = state;
  showGame();
});

socket.on('my_cards', (cards) => {
  console.log('Received my cards:', cards);
  myCards = cards;
  if (gameState) {
    showGame();
  }
});

socket.on('error_msg', (msg) => {
  console.error('Server error:', msg);
  alert('–û—à–∏–±–∫–∞: ' + msg);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
showLobby();
</script>
</body>
</html>