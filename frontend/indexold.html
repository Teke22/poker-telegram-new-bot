<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Poker</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  padding:20px;
}
button {
  padding:10px;
  margin:5px;
  background:#1a6b52;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
button:hover {
  background:#248464;
}
button:disabled {
  background:#555;
  cursor:not-allowed;
}
input {
  padding:8px;
  margin:5px;
  width:100px;
  border-radius:5px;
  border:1px solid #ccc;
}
.card {
  background:#fff;
  color:#000;
  padding:10px;
  margin:6px;
  border-radius:8px;
  display:inline-block;
  font-weight:bold;
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.box {
  border:2px solid #1a6b52;
  padding:15px;
  margin-top:15px;
  border-radius:10px;
  background:rgba(26, 107, 82, 0.1);
}
#status {
  margin-bottom:15px;
  font-weight:bold;
  padding:10px;
  background:rgba(255, 193, 7, 0.2);
  border-radius:5px;
}
ul {
  list-style-type:none;
  padding:0;
}
li {
  padding:5px 0;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
</style>
</head>

<body>

<!-- üîî STATUS -->
<div id="status" style="margin-bottom:15px;font-weight:bold;"></div>

<div id="app"></div>

<script>
const tg = window.Telegram?.WebApp;

/* ---------- USER ---------- */

let me;
if (tg && tg.initDataUnsafe?.user) {
  me = tg.initDataUnsafe.user;
} else {
  me = { id: 'debug_' + Math.random().toString(36).substr(2, 9), first_name: 'Debug' };
}

/* ---------- SOCKET ---------- */

const socket = io({
  transports: ['websocket']
});

/* ---------- STATE ---------- */

let room = null;
let myCards = [];
let gameStarted = false;
let statusMessage = '';
let lastState = null;

/* ---------- UI ---------- */

function showLobby() {
  document.getElementById('status').innerText = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–æ–∫–µ—Ä!';
  document.getElementById('app').innerHTML = `
    <h2>üé¥ Poker Lobby</h2>
    <button onclick="createRoom()" style="background:#d4af37;padding:12px;font-size:16px;">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    <br><br>
    <div class="box">
      <h3>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</h3>
      <input id="code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" style="width:150px;">
      <button onclick="joinRoom()" style="background:#2e7d32;">–í–æ–π—Ç–∏</button>
    </div>
  `;
}

function showRoom() {
  document.getElementById('status').innerText = statusMessage;
  document.getElementById('app').innerHTML = `
    <h2>üéØ –ö–æ–º–Ω–∞—Ç–∞: ${room.code}</h2>
    
    <div class="box">
      <h3>üë• –ò–≥—Ä–æ–∫–∏ (${room.players.length}/8)</h3>
      <ul>
        ${room.players.map((p, i) => `
          <li>${i === 0 ? 'üëë ' : ''}${p.name} ‚Äî üí∞ ${p.chips} —Ñ–∏—à–µ–∫</li>
        `).join('')}
      </ul>
    </div>

    ${room.players.length >= 2 ? `
      <button onclick="startGame()" style="background:#d4af37;padding:12px;font-size:16px;">üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    ` : `
      <div class="box">
        <p>‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞‚Ä¶</p>
        <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∫–æ–º–Ω–∞—Ç—ã: <strong>${room.code}</strong></p>
      </div>
    `}
    
    <br><br>
    <button onclick="leaveRoom()" style="background:#c62828;">üö™ –í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã</button>
  `;
}

function renderBoard(state) {
  if (!state.communityCards?.length) {
    return '<div class="box"><h3>–ë–æ—Ä–¥</h3><p>üÇ† –ö–∞—Ä—Ç—ã –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç—ã</p></div>';
  }

  return `
    <div class="box">
      <h3>üìä –ë–æ—Ä–¥ (${state.stage})</h3>
      ${state.communityCards.map(c =>
        `<span class="card" style="font-size:18px;">${c.rank}${c.suit}</span>`
      ).join('')}
    </div>
  `;
}

function renderGame(state) {
  lastState = state;
  
  if (state.finished) {
    document.getElementById('status').innerText = statusMessage || 'üéâ –†–∞–∑–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
  } else {
    document.getElementById('status').innerText = statusMessage || `üé≤ –°—Ç–∞–¥–∏—è: ${state.stage} | –ë–∞–Ω–∫: ${state.pot}`;
  }

  gameStarted = true;
  const current = state.players.find(p => p.id === state.currentPlayerId);
  const meState = state.players.find(p => p.id === me.id);
  
  if (!meState) {
    document.getElementById('app').innerHTML = `
      <h2>–û—à–∏–±–∫–∞</h2>
      <p>–í—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —ç—Ç–æ–π –∏–≥—Ä–µ.</p>
      <button onclick="location.reload()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–æ–±–±–∏</button>
    `;
    return;
  }

  document.getElementById('app').innerHTML = `
    <h2>üéÆ –ò–≥—Ä–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</h2>
    
    <div class="box">
      <p>üìä –°—Ç–∞–¥–∏—è: <b>${state.stage}</b></p>
      <p>üí∞ –ë–∞–Ω–∫: <b>${state.pot}</b></p>
      ${state.currentBet > 0 ? `<p>üíµ –¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: <b>${state.currentBet}</b></p>` : ''}
      <p>üéØ –•–æ–¥: <b>${current?.name || '–æ–∂–∏–¥–∞–Ω–∏–µ...'}</b></p>
    </div>

    ${renderBoard(state)}

    <div class="box">
      <h3>üë• –ò–≥—Ä–æ–∫–∏</h3>
      <ul>
        ${state.players.map(p => `
          <li style="padding: 8px; margin: 2px 0; ${p.id === me.id ? 'background: rgba(26, 107, 82, 0.3);' : ''}">
            ${p.id === state.currentPlayerId ? 'üëâ ' : ''}
            ${p.id === me.id ? 'üë§ ' : ''}
            ${p.name} 
            ${p.folded ? '‚ùå (fold)' : ''}
            ${p.allIn ? '‚ö†Ô∏è (all-in)' : ''}
            ‚Äî üí∞ ${p.chips}
            ${p.bet > 0 ? `<span style="color: #d4af37;"> (—Å—Ç–∞–≤–∫–∞: ${p.bet})</span>` : ''}
          </li>
        `).join('')}
      </ul>
    </div>

    <div class="box">
      <h3>üÉè –í–∞—à–∏ –∫–∞—Ä—Ç—ã</h3>
      ${myCards.length > 0 ? 
        myCards.map(c => `<span class="card" style="font-size:20px;">${c.rank}${c.suit}</span>`).join('') : 
        '<p>–ö–∞—Ä—Ç—ã –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã</p>'}
    </div>

    <br>

    ${!state.finished && state.currentPlayerId === me.id
      ? renderActions(state, meState)
      : state.finished 
        ? '<div class="box"><p>üéâ –†–∞–∑–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–æ–≤–∞—è –Ω–∞—á–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥...</p></div>'
        : '<div class="box"><p>‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</p></div>'}

    <br>
    <button onclick="leaveGame()" style="background:#c62828; padding:10px 20px;">
      üö™ –í—Å—Ç–∞—Ç—å –∏–∑-–∑–∞ —Å—Ç–æ–ª–∞
    </button>
    <br><br>
    <button onclick="showRoom()" style="background:#555; padding:8px 16px;">
      ‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
    </button>
  `;
}

function renderActions(state, meState) {
  if (meState.folded) return '<div class="box"><p>‚ùå –í—ã —Å–±—Ä–æ—Å–∏–ª–∏ –∫–∞—Ä—Ç—ã</p></div>';
  if (meState.allIn) return '<div class="box"><p>‚ö†Ô∏è –í—ã all-in</p></div>';

  const toCall = state.currentBet - meState.bet;
  const canCheck = toCall <= 0;
  
  if (state.currentBet === 0) {
    // –ù–µ—Ç —Ç–µ–∫—É—â–∏—Ö —Å—Ç–∞–≤–æ–∫
    return `
      <div class="box">
        <h3>üéØ –í–∞—à —Ö–æ–¥</h3>
        <p>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 20</p>
        <input id="betAmount" type="number" min="20" max="${meState.chips}" placeholder="–°—É–º–º–∞" value="20">
        <br><br>
        <button onclick="bet()" style="background:#d4af37;">üí∞ –ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
        <button onclick="check()" ${!canCheck ? 'disabled' : ''}>‚úì –ß–µ–∫</button>
        <button onclick="fold()" style="background:#c62828;">‚ùå –§–æ–ª–¥</button>
      </div>
    `;
  }

  // –ï—Å—Ç—å —Å—Ç–∞–≤–∫–∞ –¥–ª—è –∫–æ–ª–ª–∞
  const minRaise = state.currentBet * 2;
  const canRaise = meState.chips >= minRaise - meState.bet;
  
  return `
    <div class="box">
      <h3>üéØ –í–∞—à —Ö–æ–¥</h3>
      <p>–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: <b>${state.currentBet}</b></p>
      <p>–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: <b>${meState.bet}</b></p>
      <p>–ù—É–∂–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å: <b>${toCall}</b></p>
      ${canRaise ? `<p>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π–∑: <b>${minRaise}</b></p>` : ''}
      
      ${canRaise ? `
        <input id="raiseAmount" type="number" min="${minRaise}" max="${meState.chips + meState.bet}" 
               placeholder="–°—É–º–º–∞ —Ä–µ–π–∑–∞" value="${minRaise}">
        <br><br>
      ` : ''}
      
      <button onclick="call()" style="background:#2e7d32;">
        ${toCall > 0 ? `üìû –ö–æ–ª–ª (${toCall})` : '‚úì –ß–µ–∫'}
      </button>
      
      ${canRaise ? `
        <button onclick="raise()" style="background:#d4af37;">üìà –†–µ–π–∑</button>
      ` : ''}
      
      <button onclick="fold()" style="background:#c62828;">‚ùå –§–æ–ª–¥</button>
      
      ${toCall >= meState.chips ? `
        <br><br>
        <button onclick="allIn()" style="background:#f57c00;">‚ö†Ô∏è All-in (${meState.chips})</button>
      ` : ''}
    </div>
  `;
}

/* ---------- ACTIONS ---------- */

function createRoom() {
  socket.emit('create_room', { user: me });
  statusMessage = '–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã...';
}

function joinRoom() {
  const code = document.getElementById('code').value.toUpperCase().trim();
  if (!code) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
    return;
  }
  socket.emit('join_room', { code, user: me });
  statusMessage = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç—ã...';
}

function leaveRoom() {
  if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã?')) {
    socket.emit('leave_room', { code: room.code, playerId: me.id });
    room = null;
    gameStarted = false;
    myCards = [];
    showLobby();
  }
}

function leaveGame() {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—Å—Ç–∞—Ç—å –∏–∑-–∑–∞ —Å—Ç–æ–ª–∞? –í–∞—à–∏ –∫–∞—Ä—Ç—ã –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã.')) {
    socket.emit('player_leave', {
      code: room.code,
      playerId: me.id
    });
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ª–æ–±–±–∏
    room = null;
    gameStarted = false;
    myCards = [];
    showLobby();
  }
}

function startGame() {
  socket.emit('start_game', { code: room.code });
  statusMessage = '–ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...';
}

function fold() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'fold'
  });
}

function check() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: 'check'
  });
}

function bet() {
  const amount = Number(document.getElementById('betAmount').value);
  const meState = lastState.players.find(p => p.id === me.id);
  
  if (!meState) {
    alert('–û—à–∏–±–∫–∞: –∏–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  if (amount < 20) {
    alert(`–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 20`);
    return;
  }
  
  if (amount > meState.chips) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∏—à–µ–∫');
    return;
  }
  
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'bet', amount }
  });
}

function call() {
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'call' }
  });
}

function raise() {
  const amount = Number(document.getElementById('raiseAmount').value);
  const meState = lastState.players.find(p => p.id === me.id);
  
  if (!meState) {
    alert('–û—à–∏–±–∫–∞: –∏–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  if (amount < lastState.currentBet * 2) {
    alert(`–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π–∑: ${lastState.currentBet * 2}`);
    return;
  }
  
  const toCall = amount - meState.bet;
  if (toCall > meState.chips) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∏—à–µ–∫');
    return;
  }
  
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'raise', amount }
  });
}

function allIn() {
  const meState = lastState.players.find(p => p.id === me.id);
  if (!meState) return;
  
  socket.emit('player_action', {
    code: room.code,
    playerId: me.id,
    action: { type: 'raise', amount: meState.chips + meState.bet }
  });
}

/* ---------- SOCKET EVENTS ---------- */

socket.on('connect', () => {
  console.log('Connected to server');
  statusMessage = '';
});

socket.on('disconnect', () => {
  document.getElementById('status').innerText = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
});

socket.on('room_joined', r => {
  room = r;
  statusMessage = `–í—ã –≤ –∫–æ–º–Ω–∞—Ç–µ ${r.code}`;
  showRoom();
});

socket.on('room_update', r => {
  room = r;
  if (!gameStarted) showRoom();
});

socket.on('game_started', ({ publicState }) => {
  statusMessage = '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!';
  document.getElementById('status').innerText = statusMessage;
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–≤–æ–∏ –∫–∞—Ä—Ç—ã
  socket.emit('get_my_cards', { 
    code: room.code, 
    playerId: me.id 
  });
  
  renderGame(publicState);
});

socket.on('game_update', (state) => {
  renderGame(state);
  
  // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–∞—à —Ö–æ–¥, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç—ã (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
  if (state.currentPlayerId === me.id) {
    socket.emit('get_my_cards', { 
      code: room.code, 
      playerId: me.id 
    });
  }
});

socket.on('hand_finished', ({ winner, reason }) => {
  if (winner) {
    statusMessage = `üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner.name}!`;
  } else if (reason === 'fold') {
    statusMessage = 'üéâ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–≤—Å–µ –∫—Ä–æ–º–µ –æ–¥–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∏–ª–∏ –∫–∞—Ä—Ç—ã)';
  } else if (reason === 'showdown') {
    statusMessage = 'üéâ –®–æ—É–¥–∞—É–Ω! –ö–∞—Ä—Ç—ã –≤—Å–∫—Ä—ã—Ç—ã.';
  } else if (reason === 'player_left') {
    statusMessage = 'üëã –ò–≥—Ä–æ–∫ –ø–æ–∫–∏–Ω—É–ª —Å—Ç–æ–ª';
  } else {
    statusMessage = 'üéâ –†–∞–∑–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
  }
  
  document.getElementById('status').innerText = statusMessage;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
  setTimeout(() => {
    if (room) {
      socket.emit('get_room_state', { code: room.code });
    }
  }, 1000);
});

socket.on('my_cards', cards => {
  myCards = cards;
  // –ï—Å–ª–∏ –∏–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
  if (gameStarted && lastState) {
    renderGame(lastState);
  }
});

socket.on('error_msg', msg => {
  alert('–û—à–∏–±–∫–∞: ' + msg);
  console.error('Server error:', msg);
});

socket.on('room_state', r => {
  room = r;
  if (!gameStarted) {
    showRoom();
  }
});

/* ---------- START ---------- */

// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–µ—Å–ª–∏ –±—ã–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ)
if (localStorage.getItem('lastRoom')) {
  const lastRoom = localStorage.getItem('lastRoom');
  document.getElementById('app').innerHTML = '<p>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</p>';
  socket.emit('reconnect_room', { code: lastRoom, user: me });
}

showLobby();

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –≤—Ö–æ–¥–µ
const originalEmit = socket.emit;
socket.emit = function(event, data) {
  if (event === 'join_room' && data.code) {
    localStorage.setItem('lastRoom', data.code);
  }
  if (event === 'create_room') {
    localStorage.removeItem('lastRoom');
  }
  return originalEmit.apply(this, arguments);
};
</script>
</body>
</html>